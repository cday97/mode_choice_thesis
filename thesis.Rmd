---
always_allow_html: yes
title: |
  | Consistent Mode Choices Across 
  | Multiple Model Frameworks
# Your thesis title should be inverted pyramid-shaped, with the longest
# line on top and shorter lines below. Add a new line as tab-|-space-Words
author: 'Christopher Day'
year: '2022'
department: 'Department of Civil and Construction Engineering'
degree: 'Master of Science'
doctype: 'thesis' # thesis or dissertation
committeeMembers: |
  Gregory S. Macfarlane, Chair 
  
  Grant G. Schultz
  
  Gustavious P. Williams
keywords: 'four step model, discrete choice model, activity-based model, microsimulation tool, mode choice model, tour purpose, multinomial logit, latent class choice model'

address: 
  - code: BYU
    address: Brigham Young University, Civil and Construction Engineering Department, 430 EB, Provo, Utah 84602
  - code: BYUPH
    address: Brigham Young University, Public Health Department, 4103 LSB, Provo, Utah 84602
footnote:
  - code: 1
    text: "Corresponding Author"
date: "`r Sys.Date()`"

# Remove the hashtag to specify which version of output you would like.
# Can only choose one at a time.
site: bookdown::bookdown_site

journal: "submitted to Health and Place"

# Note that a tab is needed on the line after the `|`.
abstract: |
  | Every day individuals make a decision about which modes of transportation they should use. Predicting this behavior perfectly is impossible, however, there are  ways to appoximating mode choice in transportation modeling. In this research we aim to increase the accuracy in predicting mode choice using transportation modeling software. Specifically we determine the significance of creating a consistent mode choice model between an activity-based model and a microsimulation tool. Oftentimes, the outputs of an activity-based model serve as the inputs to a microsimulation tool. Yet, the mode choice models betweeen these two software often vary significantly. Using ActivitySim as the activity-based model and BEAM as the microsimulation tool, we establish a consistent mode choice model within BEAM. We then model the mode choice decisions for agents in the Salt Lake City, Utah region. Their modal distributions and mode choice structures are compared to determine the effect of mode choice consistency. Interestingly, we find that a model that uses a consistent mode choice creates a modal distribution that aligns more closely with target shares. We also find that the introduction of path, person, and location variables in the mode choice utility equation helps better predict mode choice decisions. Further research is necessary in order to understand the effects of identical mode choice models between activity-based models and microsimulation tools.

  
acknowledgments: |
  Students should acknowledge funding sources. They may also use the
  acknowledgment page to express appreciation for the committee members, friends
  or family who provided assistance in research, writing or technical aspects of
  the dissertation, thesis or selected project. Acknowledgements should be simple
  and in good taste.


# Specify the location of the bibliography below
bibliography: [book.bib] 

# Download your specific csl file and refer to it in the line below.
# csl styles: https://www.zotero.org/styles

lot: true
lof: true


# ELSEVIER ----------------------------------------------------------------#
# change to elsevier format in _ouput.yml and references
# uncomment the following specifications (and comment THESIS section)

#layout: "3p, authoryear, review" #elsevier
#csl: elsevier-harvard-italics.csl #elsevier
#link-citations: yes

# THESIS ------------------------------------------------------------------#
# delete thesis.aux BEFORE building pdf book
# change to thesis format in _ouput.yml and references
# uncomment the following specification  (and comment ELSEVIER SECTION)

layout: '12pt, oneside, openright' #thesis use option 'oneside' for ETD, 'twoside' for printing
---


<!--chapter:end:index.Rmd-->

# Introduction 

## Problem Statement
The advent of novel transport modes has challenged forecasters to develop new methods of capturing behavior and estimating service capabilities. The usage of bike share, an affordable and sustainable bike rent program, has been modeled countless times each with a different methodology (e.g., @hyland18, @biehl19, @cho22, @li18, @welch20, @zhou19, @song19). Forecasters are riddled with determining the best technique for understanding who uses e-scooters (public electric scooters) and in what locations they would be most effective (e.g, @zuniga22, @tuli21, @zhang21, @lee21, @leeb21, @hosseinzadeh21). (sentence on e-bikes). In general, forecasters have modeled micromobility (bike share, e-scooters, e-bikes) in many ways, yet few have attempted to model multiple novel modes simultaneously (e.g., @reck21, @campbell16, @lazarus20, @mckenzie19, @younes20). Ride hail and ride share, which allow users to hire a driver, behave differently than regular car modes. Given their unique nature, understanding their behavior and service capabilities is particularly challenging (e.g., @kang21, @li20, @dong20, @dean21). Forecasters have even attempted to understand the effects of autonomous vehicles, even though to date little to no data exists on fully-autonomous vehicles (e.g., @mo22, @wadud21, @zhou20). New transport technologies are becoming more prominent each day, and equally so is the need to accurately capture their behavior. 

Various efforts have been made to model novel transport modes accurately, but since methodologies are dissimilar with one another it remains difficult to determine the best approach. For example, some forecasters have chosen to model novel transport modes with an activity-based model, which uses daily activity patterns as the central tool to model an individualâ€™s travel behavior (e.g., @xu19, @muhammad19, @macfarlane21). Other forecasters use multi-agent simulation, which focuses on modeling the interactions between different agents, to understand new transport technologies (e.g., @shimizu13, @sanchez19, @horl19b). **Many forecasters have modeled novel modes using a logit based regression analysis, which uses a function to understand characteristics of the modes (e.g., @welch20, @lee21, @dong20).**(delete? -- logit regression is used in abm/mas models) Some chose a simpler approach, spatial analysis and geography data, to understand new transport technologies (e.g., @hyland18, @cho22, @hosseinzadeh21). Forecasters have even attempted to use machine learning to better understand novel modes! (e.g., @zhou19). With limited data on novel transport modes, the validity of the results from each approach can be difficult to verify. 
 
## Purpose of Research 
In this paper we examine novel mode forecasts generated by different activity-based model and multi-agent simulation mode choice combinations. By examining the ride hail service capabilities between each combination, we hope to understand which mode choice combination is best, or if a best combination even exists. Since only limited data on novel mode usage exists, it seems logical to use a trial and error approach to determine the best way to model new transport technologies. Overall, this paper aims to give forecasters additional direction in how to model novel transport modes.







<!--chapter:end:01-intro.Rmd-->

# Literature Review

As discussed in the introduction, forecasters model novel transport modes using activity-based models, multi-agent simulation, spatial analysis, machine learning, and more. Since our research mainly focuses on activity-based models, multi-agent simulation, and the link between them both, understanding the other model frameworks is not within the scope of this project. For this reason, the following literature review outlines the strengths and weaknesses of activity-based models and multi-agent simulation, the previous attempts to model novel transport modes with activity-based models and multi-agent simulation, and the brief literature of those who have attempted to reconcile two modeling approaches within the same study. Within the scope of this paper however, it is not practical to provide a comprehensive review of all activity-based models, multi-agent simulations, or paired modeling approaches. 

## Introduction to Activity-based Models {#lit-abm}

Activity-based models are transportation models that construct daily activity patterns from behavioral choice models. They predict what activities are conducted, where those activities are conducted, the length and time of those activities, and the people involved in those activities. This detailed approach to modeling behavior allows forecasters to understand travel at a high level both spatially and temporally. According to @philip13, activity-based models generate travel demand by first modeling activity demand. Understanding the idea that all travel is generated by activities is essential to accurately representing the way people travel. This link between activity and travel allows activity-based models to model behavior especially well, which is particularly advantageous when modeling novel modes. @bowman98 also explains that activity-based models have choice models that use utility theory and logit based regression to estimate behavior. These choice models accept an array of inputs relating to person, household, and regional data, to better capture the travel behavior of any particular region. 

In addition to representing behavior accurately, another advantage to using activity-based models is that there is modal consistency between trips on the same tour (e.g., @nayak22, @hasnine21, @knapen21, @gomes21). @nayak22 explains that other existing models fail to consider the "interrelationships among trips" performed by the same individual on the same tour. For example, if you were to take your car to the gym, and then stop by the store on the way back home, wouldn't you also use your car to get from the store back to your home? Individuals will act similarly among trips of the same tour, and activity-based models account for this natural tendency. @hasnine21 explains that tour based modeling is the core of activity-based models; "tackling" every trip within a tour is essential to understanding the dynamics that exists between trips. @gomes21 explains that trip-based models, unlike activity-based models, disregard trip sequences, trips made by the same individual, and the relationship between trips and activities. Chaining trips of the same individual together, within the same tour, helps ensure modal consistency within models.

Knowing the advantages that activity-based models provide when modeling travel behavior, many forecasters use activity-based models to model the behavior and service capabilities of novel modes. For example, some new technologies that have been modeled with activity-based models are car-sharing (e.g., @nguyen22, @li18b) and autonomous vehicles (e.g., @xu19, @vyas19). @nguyen22 modeled one-way car-sharing services with an activity-based model because the modal consistency between trips allowed them to track vehicle demand, pricing, and other parameters. @xu19 modeled privately-owned autonomous vehicles with an activity-based model as a way to better understand their impact on household travel patterns, including very large households.  @macfarlane21 used an activity-based model to model on-demand wheelchair accessible microtransit vehicles. The activity-based model generated daily activity patterns for all individuals in the region, including those who were wheelchair dependent. With those plans they were able to simulate microtransit vehicles with a microsimulation tool, and process the results to understand service capabilities. @tzouras22 conducted a quantitative study of activity-based models for modeling e-scooters. They agreed that activity-based models are an effective vehicle to describe the spatiotemporal variation in e-scooters, and novel modes in general. @muhammad19 used an activity-based model to model bike share and even the concept of Mobility as a Service, which aims to make public transport a pay-per-service or monthly subscription. Many forecasters elect to use activity-based models to model new transport technologies because of the behavioral representation and modal consistency they provide.

Although there are advantages to using activity-based models to model novel modes, forecasters must consider the various weaknesses that exist when using activity-based models. One of the biggest shortfalls within most activity-based models is that travel times are averaged along travel links (e.g., @rsg16, @mahmoudi21). For example, although @nguyen22 used an activity-based models to model one-way car sharing, they noted that it used the BPR function to estimate travel time. The BPR function is a regression function that estimates average travel time based on arrival flows. When using the BPR function to estimate smaller time intervals though, it becomes inconsistent. For this reason, @nguyen22 noted that it was more difficult to verify the service capabilities of the car-sharing modes. Similarly, on-demand microtransit vehicles should be modeled with variable wait time; the difference between a 4 minute wait and a 17 minute wait is significant when traveling. @macfarlane21 recognized this shortcoming, and elected to estimate the on-demand travel time by using a multi-agent simulation on top of an activity-based model. Overall, since travel time is a significant part of the mode choice utility, average travel time is a shortfall when modeling novel modes. 

Another typical weakness present in most activity-based models is their focus on individual-based behavior, instead of household-based behavior. Although it is widely known that many decisions made by humans are done collectively, little effort has been made to model travel based on intra-household interactions and group decisions making [@zhang06]. However, some forecasters have attempted to account for this shortfall (e.g., @zhang06, @neutens08, @soo09). @neutens08 and @soo09 in particular attempted to extend individual-level travel to household-level travel by assigning certain tasks (activities) to different household individuals, verifying that schedules within the same households were coherent, and developing a household utility measure. @zhang06 developed a household utility function to help represent the "diverse intra-household interactions". Travel behavior is more than just a set of strung together activities, and certain interactions (e.g., household-based decisions) are important to consider when modeling transport modes.

## Introduction to Multi-agent Simulation {#lit-mas}

An alternative to activity-based models for forecasting novel modes is multi-agent simulation. Multi-agent simulation, usually synonymous with the term microsimulation, models interactions between individual agents. Multi-agent simulation is a desirable tool because it allows analysis to be done on both the individual and group levels; individualized decisions can be explored (e.g., @kamel19) as well as agent to agent interactions (e.g., @bazghandi12, @amblard15, @siebers08). These agent to agent interactions and individualized decisions allow forecasters to better understand why a novel mode may or may not be chosen. For example, multi-agent simulation allows forecasters to know exactly how many users participate in a novel transport mode, which type of users are interested in a novel transport mode, and if other agents played a role in the novel transport mode choice decision.  

Along with modeling unique agents, another reason multi-agent simulation is advantageous for modeling novel modes is its transportation network and capacity constraint. Transportation networks are visual representations of the actual road networks, and allow forecasters to see the transportation decisions made by each agent. In addition to being visual tools, agents are coded to the network allowing them to interact with attributes of the network itself. For example, @dia02 used a real traffic network in their model to simulate areas of high traffic congestion. Within the model, agents could notice high congestion areas and some of them would chose to take an alternate route. Due to the interaction between individual agents and roadway conditions, realistic travel behavior is captured on a global scale.  @djavadian17 and @fujii17 also used a real transportation network to capture realistic global travel behavior. @djavadian17 explored the usage of flexible mobility systems like taxi and carpool and @fujii17 explored mixed traffic consisting of cars, pedestrians, and trams. @fujii17 even enhanced the basic transportation network system by coding various virtual driving lanes at each intersection, thus making the network even more realistic. @cetin02 describes two more benefits of road networks: one, vehicles are subject to remain on network links for a certain amount of time (according to their travel speed) and, two, a storage capacity exists for each link that once met, no more vehicles can enter. By using a transportation network, the travel times, speeds and congestion become reliable model outputs, and therefore, the travel times, speeds, and congestion of novel modes are easily modeled. Multi-agent simulation uses unique agents with a realistic transportation network to create attainable and reliable model outputs.   

Due to the advantages that multi-agent simulation provides, various forecasters have elected to use them to model novel transport modes. For example, @kamel19 chose to use a multi-agent simulation to model shared autonomous vehicles because decision-making was done on an individual level. This granularity helped the researchers understand how user preferences affected the modal split of shared autonomous vehicles. @horl19b also analyzed shared autonomous vehicles with a multi-agent simulation, mainly to take advantages of the detailed network dynamics. By utilizing the detailed network, the researchers were able to estimate the system performance, wait times, and cost of various autonomous vehicle fleets. Other analyses have been completed on other novel modes like with shared mobility (e.g., @ciari16, @shimizu13, @becker20) and electric vehicles (e.g., @sanchez19). Specifically, @ciari16 summarizes a multitude of research done to understand demand for car-sharing with the multi-agent simulation model MATSim. In this research, they note that although multi-agent simulation provides an extensive level of detail, it does not necessarily equate to real world accuracy. A model rich in detail and with extensive behavioral rules, however, allows innovative transportation technologies to be analyzed efficiently in a world where "solid behavioral knowledge does not yet exist". Therefore, by using MATSim, @ciari16 surpassed the typical pitfalls of modeling a new transport mode like car-sharing, and adequately modeled the individual travel decisions with a high temporal and spatial resolution. Similarly, @becker20 used MATSim to model different shared mobility services (car-sharing, bike-sharing, ride-hailing). By using a multi-agent simulation, multiple novel transport modes could be analyzed simultaneously within the same model. Many forecasters continue to analyze new transportation technologies with multi-agent simulation because its inherit advantages are helpful to understanding service capabilities.

Although the advantages within multi-agent simulation are useful to modeling novel modes, forecasters must be aware of the weaknesses within these models as well. For example, although @kamel19 used multi-agent simulation to model shared autonomous vehicles, they understood that the homogeneous behavior structure may decrease the accuracy of their results. A homogeneous behavior structure means that all agents within the model have similar preferences when facing decisions, like mode choice. This renders results to be less accurate since oftentimes people choose a specific mode based solely on their personal preference. @tchappi18 reviews many of the advantages of a holonic multi-agent simulation (holonic meaning to divide the system into dependent groupings), but acknowledges the weakness that driver behavior is not homogeneous. The other major weakness of multi-agent simulations is their high computational requirements (e.g., @siebers08, @cetin02, @adler05). In order to adequately model the individualized nature of every agent, while mapping each agent to a detailed road network, affluent computing power is needed. The need for a high processing computer and sufficient computing time is indeed a limitation for some forecasters.

Another inherit weakness of most multi-simulation models is its focus on trips-based modeling. Most multi-simulation models only simulate agents on a trip level, ignoring the tour-based framework present in most activity-based models. Figure \@ref(fig:fig-mode-compare) provides a visual example of this difference. If a person wants to go to their work activity by train, an activity-based model knows that they can either walk or take transit to their gym activity. Contrastingly, a multi-agent simulation bases mode choice on the first trip of the day. This means that a multi-agent simulation will determine the optimal mode to go to the gym in, and then figure our how to get to work based on the first trip mode. In addition, an activity-based model knows that when a person leaves for lunch from their work activity, they will be returning back to their work activity after lunch. This means that the person is able to leave their car at work and possibly walk or take transit to and from their lunch activity. In a multi-agent simulation though, if someone goes to lunch, they will most likely take their car as to not abandon their vehicle for the rest of their day. It is clear that a multi-agent simulation's mode choice is less representative of how people actually transport themselves during the day. An activity-based model provides a better representation of mode choice. In this research we attempt to link a activity-based model and a multi-agent simulation tool as to use the advantages of both models to better model novel transport modes.

```{r fig-mode-compare, out.width='100%', fig.cap='Mode Choice in Activity-based Models and Multi-agent Simulation.', out.width='100%', fig.asp=1, fig.align='center', echo=FALSE}
knitr::include_graphics("pics/abm-mas-compare.png")
```

## Limited Attempts to Pair Two Disparate Modeling Approaches

The varying strengths and weaknesses within both activity-based models and multi-agent simulation point to possibly using both approaches to understand novel mode behavior. Yet few forecasters have attempted to reconcile or pair these two disparate approaches in order to better understand novel mode behavior. However, one example of reconciling the traditional approaches is with the system MITO (e.g., @moeckel20, @zwick21). MITO stands for Microsimulation Transport Orchestrator, and its primary purpose is to overcome the limitations of the traditional trip-based model while being easier to implement than the traditional activity-based model. Like a multi-agent simulation, MITO simulates each agent individually, however, MITO also restricts agents of the same household with a travel time budget. This travel time budget influences destination choice, and ensures that agents participate in sensible activities (e.i. those household members who commute to work are less likely to perform shopping and discretionary activities). MITO includes a simplified activity schedule builder, allows forecasters to add attributes, allows agent tracing, and is not as computationally heavy as traditional multi-agent simulations [@moeckel20]. @zwick21 used MITO to estimate travel demand and MATSim, a multi-agent simulation tool, to simulate that demand. By pairing together MITO and MATSim, the researchers were able to gather service criteria for a novel transport mode: pooled on-demand ride hailing vehicles. 

Traditionally, MATSim implements a feedback loop to determine mode choice instead of using a discrete choice model. For example, if in one iteration too many agents choose a car mode and travel times go up, in the next iteration some agents will opt to use an alternative mode. This process continues until equilibrium is found between the supply and demand. Some researches have attempted, however, to pair together a discrete mode choice models with MATSim in attempt to shorten the number of iterations needed to be run. For example, @horl19 discovered that by using a discrete choice model within MATSim, no irrelevant mode choice decisions were made. This indeed, lead to less iterations being run. However, although initial modal decisions were more accurate than the default MATSim model, the discrete choice model added a layer of complexity. Accurate and consistent data is needed in order for the discrete choice model to work effectively. This need for more data gives the model runners less freedom. @horl19 mentions that their research was merely an introduction to the concept, and further research is desirable to understanding all the benefits of linking discrete choice and simulation based tools.

Another example of pairing together two different modeling approaches is with an activity-based model and a dynamic traffic assignment model (e.g., @zhang18, @pendyala17, @shiftan00). Dynamic traffic assignment models are useful as they understand time-dependent interactions, simulate individual agents, capture congestion, and can model new transportation technologies [@zhang18]. Pairing together activity-based models and dynamic traffic assignment models is of great interest to forecasters, as their structures are similar and together they produce results at a finer level of detail. @zhang18 paired together InSITE, an activity-based model, with DTALite, a dynamic traffic assignment model, to model travel demand in the Baltimore-Washington region. Their conclusion was that the integrated model performed better than the singular InSITE activity-based model. Overall, they determined that the integrated model produced better results, but was more challenging to run and required consistent upkeep to ensure consistency between models. 

To the authors knowledge, no previous literature exists on pairing together an activity-based model with a multi-agent simulation for the purpose of modeling novel mode behavior. Yet both activity-based models and multi-agent simulation have their own unique strengths when it comes to modeling novel modes. Could using both an activity-based model and a multi-agent simulation within the same study maximize each model's strengths while limiting each model's weaknesses? There exists a need to understand which methodology is best for modeling novel modes, or if a best methodology even exists. The objective of this study is to better understand the effects of using different mode choice combinations between varying activity-based models and multi-agent simulation combinations. We aim to use these results to provide forecasters guidance as to which choice model combination they should use to model novel modes. 


<!--chapter:end:02-lit-review.Rmd-->

---
header-includes:
  - \usepackage{algorithm}
  - \usepackage{algpseudocode}
  - \usepackage{dsfont}
---

```{r, include = FALSE}
library(targets)
library(tarchetypes)
library(tidyverse)
library(data.tree)
library(RAM)
library(knitr)
library(kableExtra)

# Instructions and options =========
# prints missing data in tables as blank space
options(knitr.kable.NA = '') 
# tells kableExtra to not load latex table packages in the chunk output
options(kableExtra.latex.load_packages = FALSE) 

# options for latex-only output
if(knitr::is_latex_output()) {
  knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
} 
```



# Methods
We developed a series of experiments to understand the relative importance of activity-based and multi-agent simulation in forecasting the uptake of novel modes. These experiments were performed using ActivitySim as the activity-based model and BEAM as the multi-agent simulation tool. We used the Salt Lake City, Utah region as a case study for our experiments. Since ride hailing vehicles were an emerging technology in the region at the time of our study, we deemed it the appropriate novel transport mode to model in our experiments. The following section outlines the methodology for which we were able to model a novel transport mode with differing activity-based model and multi-agent simulation mode choice combinations.

## ActivitySim as the Activity-based Model {#meth-asim}
ActivitySim is an activity-based simulator used to generate plans for millions of agents each with their own demographic attributes [@gali08]. Instead of independently modeling each trip, ActivitySim simulates each individual by calculating their daily travel diaries and schedules. Long term decisions are made first, and then shorter term decisions are calculated based on those long term decisions [@rsg21]. Overall, ActivitySim is an advanced activity-based model with the same advantages and disadvantages described in Section \@ref(lit-abm).

### Novel Modes in ActivitySim
ActivitySim was chosen as the activity-based model in this research because built into its framework are the novel modes of ride hail and pooled ride hail. Specifically, ride hail and pooled ride hail fall under one of the four nested tiers of ActivitySim's nested logit model. This means that ride hail is a unique modal option not characterized by being an auto, non-motorized, or transit type mode. Figure \@ref(fig:fig-asim-nest) displays the four tiers of the nested logit along with the modal alternatives of each tier [@mtc12]. These modal alternatives represent the alternatives available in both ActivitySim's tour based and trip based mode choice model. When determining the mode to use on a trip, ActivitySim first calculates the tour mode and subsequently calculates the trip mode based on the tour mode selection (See Figure \@ref(fig:fig-mode-compare)). Person attributes, path attributes, location attributes, tour purpose value, and more all play a role in calculating the mode choice decision. 

```{r fig-asim-nest, fig.cap = "ActivitySim Nested Logit Model.", fig.asp=1, fig.align='center', out.extra = 'trim = {5cm 6.5cm 12.5cm 4cm}', out.width=".7\\textwidth", wrapfigure = list("R", .5),  echo=FALSE}
choice <- Node$new("Choice")
  auto <- choice$AddChild("Auto")
    drivealone <- auto$AddChild("Drive-Alone")
    sharedride2 <- auto$AddChild("Share-Ride 2")
    sharedride3 <- auto$AddChild("Shared-Ride 3+")
  nonmotorized <- choice$AddChild("Non-Motorized")
    walk <- nonmotorized$AddChild("Walk")
    bike <- nonmotorized$AddChild("Bike")
  transit <- choice$AddChild("Transit")
    walkaccess <- transit$AddChild("Walk-Transit")
    driveaccess <- transit$AddChild("Drive-Transit")
  ridehail <- choice$AddChild("Ride-Hail")
    taxi <- ridehail$AddChild("Taxi")
    tnc_single <- ridehail$AddChild("Ride-Hail Single")
    tnc_shared <- ridehail$AddChild("Ride-Hail Shared") 
#print(choice)

SetNodeStyle(choice, style = "filled,rounded", shape = "box", fontname = "helvetica", tooltip = GetDefaultTooltip)
plot(choice)
```

In addition to using specific attributes to determine the mode choice decision, ActivitySim also sets default parameters for choosing ride hail and pooled ride hail vehicles. For example, a base fare, cost per mile, cost per minute, and cost minimum are all set before model runs. These values can be changed between model runs, but are held constant for all ride hail vehicles in the same model run. In addition, a mean wait time is used to help calculate the total travel time of ride hail vehicles. This means that all mode choice decisions to choose ride hail vehicles use the same wait time in the utility calculation. There is no variability in wait time between one agent using ride hail against another. One exception however, is that there are 5 different mean wait time values depending on the location of the ride hail request. Mean wait times also differ between single ride hail trips and shared ride hail trips. There is also one parameter for the maximum allowed wait time for a ride hail vehicle. Overall, it was essential to use ActivitySim to model ride hail vehicles because the mode choice structure fostered accurate behavioral representation and modal consistency between trips. However, ActivitySim's absence in using variable wait time to calculate the ride hail choice utility led us to also modeling ride hail vehicles with a multi-agent simulation (See Section \@ref(meth-beam)).

### ActivitySim Configured to the Case Study Region
ActivitySim was configured to the case study region by first gathering and generating the input data. Three input files were necessary in order to run ActivitySim:

  1. A synthetic population of the agents within the study area.
  2. A zonal socioeconomic data file describing the characteristics of each zone.
  3. A set of skims that describe the cost and travel times of all modes between all zones.
  
A synthetic population is a generated population with specific individual attributes that add up to the regional characteristics as a whole. We generated the synthetic population using a software called PopulationSim [@popsim]. We used a "seed" table, which represented information of a subset of the population, and a set of "targets", which represented demographic data of smaller areas of the region, to run PopulationSim [@nate]. The zonal socioeconomic data file stores zonal characteristics regarding household, worker, and other activity type information. This file was created using data from Wasatch Front Regional Council (WFRC) [@wfrc], Utah Automated Geographic Reference Center [@agrc], and the synthetic population when necessary. The skims are large matrices showing travel times and costs between every set of zones within the area of study. Included in these skims were further details regarding differences in modes, distances, wait times, etc. [@nate]. We used pre-generated skims from @wfrc, with some slight adjustments, in our run of the ActivitySim model.

After generating the necessary input files, we calibrated and validated the ActivitySim model to better represent decisions made in the Salt Lake region. The process of calibrating and validating the ActivitySim model to the Salt Lake region was conducted by @nate. The purpose of the calibration and validation was to ensure that the outputs generated by ActivitySim matched target regional values. Specifically, trip productions, trip distributions, and mode choices were tested to match the given target values from the four-step model from @wfrc. The details behind the exact calibration and validation process are discussed by @nate, and therefore will not be described in detail within this paper. However, we did conduct one additional calibration measure beyond that which @nate completed. Due to some slight adjustments made after the initial calibration of ActivitySim, we elected to re-calibrate ActivitySim's tour mode choice parameters. Using the 2012 household travel survey as our targets, we improved ActivitySim to model a more accurate total modal distribution of the region [@hhts12]. Figure @blah shows the results of the iterative calibration process. The fully calibrated and validated ActivitySim model was then ready to run and generate activity plans for the case study region.

## BEAM as the Multi-agent Simulation Tool {#meth-beam}
BEAM stands for Behavior, Energy, Autonomy, and Mobility and is a multi-agent simulation tool being developed by Lawrence Berkeley National Laboratory and UC Berkeley Institute for Transportation Studies [@beam]. As an extension of MATSim, it simulates individual agents using both within day replanning and across-day replanning to maximize individual utility. Overall, BEAM shares many of the same advantages and disadvantages of most multi-agent simulations as described in Section \@ref(lit-mas).

### Novel Modes in BEAM
BEAM was chosen as the multi-agent simulation in this research because of its integration with transportation network companies (TNCs), or ride hail and pooled ride hail vehicles. (BEAM also supports plug-in electric vehicle modeling, however, this feature was not used within our research.) Along with the TNC type mode options, BEAM supports many of the regular choices as well, such as car, walk, bike, walk-to-transit, and drive-to-transit.  Default BEAM uses a simple multinomial logit choice model for determining which mode any particular agent will use on any particular trip. Only a few variables are used to calculate the modal alternative: cost, travel time, number of transfers, and an alternative specific constant (ASC) [@beam].

BEAM was also chosen as the multi-agent simulation in this research because of how it implements ride hailing vehicles. BEAM uses a greedy asynchronous ride hail matching algorithm that also supports pooled trips. The algorithm works by first, requiring agents to send a request for a ride hail vehicle, and then by second, matching the closest vehicle to that agent. For the algorithm to work, BEAM requires the modeler to input a ride hail vehicle fleet. This fleet is a simply file that describes the number of ride hailing vehicles available in the region, their starting locations, their working hours, their seating capacity, and other specifications. BEAM assigns these vehicles to the roadway network, where they "roam" the streets awaiting requests. The ride hail algorithm permits a more realistic ride hail modeling structure. For example, agents make a request to take a ride hail vehicle, expect a variable wait time dependent on their geographic location, and may not even be able to take the vehicle if there is no availability! All these attributes are similar to how using ride hail is in real life, and represent the true advantages to modeling ride hail with BEAM. 

### Linking the Mode Choice of ActivitySim and BEAM
In order to use BEAM in conjunction with ActivitySim, however, its mode choice model was updated to be more consistent with ActivitySimâ€™s mode choice model. More specifically, three changes were made to the choice structure:

  1. Adding a Tour Purpose Attribute
  2. Adding Person, Path, and Location Attributes to the Utility Equation
  3. Adding New Modal Alternatives
  
First, a tour purpose attribute was added at the trip level, to be used when making trip-based modal decisions. ActivitySim's default utility parameters are segmented by tour purpose, auto ownership, and mode; therefore, adding a tour purpose level attribute was essential to calculating the mode choice utility similar to ActivitySim. 

Second, multiple person, path, and location related attributes were added to use in the mode choice utility equations. The MTC example of Activityim (the example referenced in this research) uses 25 different variables in the utility calculation [@mtc12]. So, BEAM was adjusted to use values like wait time, transit proximity, distance, age, household size, and more on top of the default variables to calculate modal utility. This was done by gathering path and location variables from the BEAM router and person level variables from the input files. ASCs were copied directly from the MTC ActivitySim example, and then calibrated later on. Overall, one input file was created which housed all path, person, and location type parameters on a tour purpose, auto ownership, and modal level. 

The last major adjustment made to the BEAM software was adding new modal alternatives. The most important difference between the ActivitySim modal options and the BEAM modal options is the inclusion of carpooling vehicles (HOV2 and HOV3). HOV2 means High Occupancy Vehicle with 1 passenger (2 people in the vehicle) and HOV3 means High Occupancy Vehicle with 2 or more passengers (at least 3 people in the vehicle). The BEAM software was adjusted to include HOV2 and HOV3 type modes, including a distinction between drivers and passengers of those vehicles. Within the code, HOV2 and HOV3 modes were provided as modal options by transforming an existing car option into an HOV option. This allowed car travel statistics to be transferred over to the carpooling modes, which were essential to calculating the utility.

BEAM's default mode choice model was adjusted dramatically to be more closely aligned with how the MTC example of ActivitySim handles mode choice [@mtc12]. As a way to better understand the complexity of the new mode choice model in BEAM, two pseudocode algorithms are provided. Specifically, the algorithms are meant to provide clarification on how BEAM's new mode choice model works.

Algorithm 1 describes the process behind determining the mode choice alternatives for each agent. This process occurs for every agent for every trip. Two procedures are presented within the first algorithm. The first procedure is called DetermineHOVAlternatives. This procedure was added to the BEAM code as a way to include carpooling options. In this procedure the HOV alternatives are created from already existing options created by the R5 router [@r5]. (The R5 routing engine helps BEAM accomplish multi-modal routing). Basically if a car, HOV2, or HOV3 mode is already created from the router, then both HOV2 and HOV3 options are provided. If car is not provided by the router, then passenger HOV options are provided. Passenger HOv modes, called HOV_TELEPORT, are completed by teleporting agents from origin to destination. The second procedure within Algorithm 1 describes the process behind determining the final modal alternatives. It essential states that if the current mode is already chosen, then that mode remains as the only alternative to choose from. However, if no mode is currently chosen for the trip, the router, ride hailing, and HOV alternatives are combined and presented as the final alternatives to choose from. 

\begin{algorithm} [tph]
\caption{Algorithm for Determining Mode Choice Alternatives in BEAM}
\begin{algorithmic}[1]
\Require
\State $i : origin$
\State $j : destination$
\State $n: agent$
\State $N: population$
\State $t : trip $
\State $P : plan$
\State $\vec{R}(i,j) : Router\: alternatives$
\State $\vec{RH}(i,j) : Ridehail\:alternatives$
\State $\vec{H}(i,j) : HOV\:alternatives$
\State $\vec{M}(i,j) : Final\:modal\:alternatives$
\State $C : Current\:Mode$
\State $I : Trip\:Index$
\vspace{4pt}\hrule\vspace{5pt}

\State $\vec{R} \equiv \vec{R}(i,j)$
\State $\vec{RH} \equiv \vec{RH}(i,j)$
\State $\vec{H} \equiv \vec{H}(i,j)$
\State $\vec{M} \equiv \vec{M}(i,j)$
\For {$n \in N$}
\For {$t \in P$}

\Procedure {DetermineHOVAlternatives}{$\vec{R}$, $C$}
\If {$C=None$}
  \If {$\vec{R} \ni CAR$}
    \State $\vec{H} \gets (HOV2,HOV3)$
  \ElsIf {$\vec{R} \ni HOV2$}
    \State $\vec{H} \gets (HOV3)$
  \ElsIf {$\vec{R} \ni HOV3$}
    \State $\vec{H} \gets (HOV2)$
  \ElsIf {$\vec{R} \ni WALK$}
    \State $\vec{H} \gets (HOV2\_TELEPORT, HOV3\_TELEPORT)$
  \EndIf
\Else
  \State $\vec{H} \gets None$
\EndIf
\EndProcedure
\Statex
\algstore{myalg}
\end{algorithmic}
\end{algorithm}

\addtocounter{algorithm}{-1}
\begin{algorithm}
\caption{continued}
\begin{algorithmic} [1]
\algrestore{myalg}
\Procedure {DetermineFinalModalAlternatives}{$\vec{R}$, $\vec{RH}$, $\vec{H}$, $C$, $I$}
\If {$C = DRIVE\_TRANSIT \lor BIKE\_TRANSIT$}
  \If {$I = 0$}
    \If {$C = DRIVE\_TRANSIT$}
      \State $\vec{M} \gets (DRIVE\_TRANSIT)$
    \Else
      \State $\vec{M} \gets (BIKE\_TRANSIT)$
    \EndIf  
  \Else
    \State $\vec{M} \gets (WALK\_TRANSIT, RIDEHAIL\_TRANSIT)$
  \EndIf
\ElsIf {$C = WALK\_TRANSIT \lor RIDEHAIL\_TRANSIT$}  
  \If {$C = WALK\_TRANSIT$}
    \State $\vec{M} \gets (WALK\_TRANSIT)$
  \Else
    \State $\vec{M} \gets (RIDEHAIL\_TRANSIT)$
  \EndIf
\ElsIf {$C = HOV2\_TELEPORT \lor HOV3\_TELEPORT$}  
  \If {$C = HOV2\_TELEPORT$}
    \State $\vec{M} \gets (HOV2\_TELEPORT)$
  \Else
    \State $\vec{M} \gets (HOV3\_TELEPORT)$
  \EndIf
\ElsIf {$C = CAR$}
  \State $\vec{M} \gets (CAR)$
\Else
  \State $\vec{M} \gets \vec{R} + \vec{RH} + \vec{H}$  
\EndIf  
\EndProcedure
\EndFor
\EndFor
\Statex
\end{algorithmic}
\end{algorithm}

Algorithm 2 describes the process within BEAM for how one modal alternative is selected among all the mode choice options. Algorithm 2 is basically the pseudocode behind the process that occurs with the mulitnomial logit function. Then, after using the multinomial logit formula, the probabilities that were calculated are sampled and one final mode choice alternative is selected!

\begin{algorithm}
\caption{Algorithm for Selecting Final Modal Alternative in BEAM}
\begin{algorithmic}[1]
\Require
\State $i : origin$
\State $j : destination$
\State $n: agent$
\State $N: population$
\State $t : trip $
\State $P : plan$
\State $\vec{A}: attributes\:of\:agent$
\State $a: attribute\:value$
\State $\vec{M}(i,j) : Modal\:alternatives$
\State $m : alternative \in M(i,j)$
\State $\vec{U}(\vec{M}(i,j),\vec{A}):Utilities\:for\:alternatives$
\State $u: utility \in \vec{U}(\vec{M}(i,j),\vec{A})$
\State $\vec{c}: attribute\:coefficients$
\State $\mathds{P}: probability$
\State $Mode: chosen\:mode\:for\:agent\:(n)\:on\:trip\:(t)$
\State $f(\vec{X}):$
This function takes a vector of modes and  their probabilities of being chosen. With those probabilities it builds them into a cumulative distribution function, generates a random number and then drops the mode with the closest probability. This process continues until only one mode is left.
\vspace{4pt}\hrule\vspace{5pt}

\State $\vec{M} \equiv \vec{M}(i,j)$
\State $\vec{U} \equiv \vec{U}(\vec{M},\vec{A})$
\For {$n \in N$}
\For {$t \in P$}\Procedure {DetermineFinalModalAlternative}{$\vec{M}$, $\vec{A}$, $\vec{c}$}
\For {$m \in \vec{M}$}
  \State $u \gets \sum_{a\in \vec{A}} a \times c_a$
  \State $\vec{U} += [m,u]$
\EndFor
\State $S \gets \sum_{u\in \vec{U}}e^u$
\For {$u \in \vec{U}$}
    \State $\mathds{P}(u)\gets e^u / S$
    \State $\vec{B} +=[m, \mathds{P}(u)]$
\EndFor 

\State $Mode \gets f(\vec{B})$

\EndProcedure

\EndFor
\EndFor
\Statex
\end{algorithmic}
\end{algorithm}


### BEAM Configured to the Case Study Region
BEAM was configured to the case study region by gathering the inputs, validating the utility parameter values, and calibrating the utility ASC values to the region. Gathering the BEAM input files were easy simply because the outputs generated by the calibrated ActivitySim model were used as the inputs to BEAM. Only a slight formatting change was made to these inputs; and since they were generated by the calibrated ActivitySim model, they were already configured to the Salt Lake region. 

The utility parameter values used in BEAM's new mode choice model were copied directly from MTC's implementation of ActivitySim [@mtc12]. MTC's implementation of ActivitySim was designed for the San Francisco, California region. Logically, travel behaviors such as travel time, travel distance, and number of transfers should affect people in different regions in similar ways. However, as a way to validate the use of ActivitySim's path utility coefficients in the Salt Lake region, these values are compared to values from the Utah Statewide model, the WFRC travel demand model, and the NCHRP Report 716. The Utah Statewide model is useful as it provides a rough idea of the influence of path variables in Utah as a whole [@utahstate]. The WFRC model model is a useful comparison as it predicts travel behavior for the same region of study used in this research project [@wfrc] . NCHRP Report 716 provides a rough idea of what parameter values should look like for a generalized modeling point of view [@nchrp]. Overall, comparing these three sets of path parameter values with the MTC ActivitySim parameter values used in BEAM helps ensure that the the utility parameters are valid.

Figure \@ref(fig:hbw) shows the comparison of the path utility parameter values between all four models for home-based work trips. For the egress time, in vehicle travel time (ivtt), the number of transfers, transfer time, and the wait times, MTC's ActivitySim seems to use a very similar coefficient value as the other three models. The largest discrepancy exists with short and long walking distances. ActivitySim seems to use a value almost ten fold that of the other models. This occurs because the WFRC and Utah Statewide models caps walking distance whereas ActivitySim instead gives a high penalty for long walking distances. With this clarification, it is clear to see that ActivitySim's path coefficient values do not require calibration and were left as is.

```{r hbw, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Home-based work mode choice path coefficients model comparison.", fig.align='center'}
tar_read(hbw_graph)
```

Figure \@ref(fig:hbs) shows the comparison of the path utility parameter values between all four models for home-based school trips. Similar to the home-based work analysis, for the egress time, ivtt, transfer time, and the wait times, ActivitySim seems to use a very similar coefficient value as the other three models. Again, the largest discrepancy exists with short and long walking distances. Since this is simply a difference between how walk distance is modeled, the discrepancy is ignored. In addition, the other three models did not have information on number of transfers. As a result, there is no comparison done with number of transfers. ActivitySim's path coefficient values do not require calibration for the home-based school parameters.

```{r hbs, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Home-based school mode choice path coefficients model comparison.", fig.align='center'}
tar_read(hbs_graph)
```

Lastly, Figure \@ref(fig:hbo) shows the comparison of path utility parameter values between all four models for home-based other trips. Again, besides for walk distance all variables seem to be similar between all four models. An interesting point is that for models other than ActivitySim, the cost coefficient varies greatly. Fortunately, ActivitySim bases the cost coefficient on each individual's value of time so this is not a concern. Overall, for all purpose types the coefficients used by ActivitySim are similar enough to other models that exist, and therefore do not require calibration. The ActivitySim alternative specific constants do, however, require calibration (See Section \@ref(clib)).

```{r hbo, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Home-based other mode choice path coefficients model comparison.", fig.align='center'}
tar_read(hbo_graph)
```

After validation was completed, the last step in order to run BEAM with the case study region was to calibrate the ASC values of the mode choice model. BEAM calibration was completed by iteratively updating the ASC values using Equation \@ref(eq:eqcalib). The number of trips totaled by tour purpose, auto ownership, and modal alternative were compared between the BEAM results and the ActivitySim results and used to adjust each ASC value. After 15 iterations of Equation \@ref(eq:eqcalib) were completed on the ASC values, the BEAM trip values were within a reasonable range to the ActivitySim target shares. Figure \@ref(fig:fig-beam-calib) shows the progress of the calibration targets with the final shares after each iteration. 

\begin{equation}
  NewASC = OldASC + ln(\frac{Trips_{ASIM}}{Trips_{BEAM}}) (\#eq:eqcalib)
\end{equation}  

```{r fig-beam-calib, out.width='100%', fig.cap='BEAM mode choice ASC calibration', out.width='100%', fig.asp=1, fig.align='center', echo=FALSE}
knitr::include_graphics("pics/BeamCalib.png")
```


## Case Study Scenarios
After BEAM validation and BEAM calibration were completed for the case study region, a series of different BEAM scenarios were run. Specifically, 10 different experiments were conducted, each with a unique ActivitySim-to-BEAM mode choice combination. Table \@ref(tb:tbexperiments) provides a short description of the 10 different scenarios. Thereafter, a more detailed description of each experiment is described. 

```{r, display=FALSE,echo=FALSE,warning=FALSE,include=FALSE}
# Scenario Number, Scenario Name, ActivitySim Input Type, BEAM Utility Function Variables, Scenario Description 
input <- c("1", "None", "With RH","Path, Person, Location","Mode Choice Off",
           "2", "All-ALL-wRH", "With RH", "Path, Person, Location", "All variables used",
           "3", "All-All-wRH", "With Ride Hail","Path", "just path variables used")
inputTable <- matrix(input,ncol=5,byrow=TRUE) %>%
  as.tibble() %>% 
  rename("Scenario Number" = V1, "Scenario Name" = V2, "ActivitySim Input Type" = V3, "BEAM Utility Variables" = V4, "Scenario Description" = V5)

```

```{r tbexperiments, echo=FALSE}
kable(inputTable, caption = 'ActivitySim - BEAM Mode Choice Combination Scenarios', booktabs = TRUE) %>%
  kable_styling(latex_options="scale_down")
#kableExtra doesn't work with algorithm!!

```





REFERENCES NEEDED: WFRC?, HHTS12, 
 

<!--chapter:end:03-methods.Rmd-->

# Results


## Table

<!--chapter:end:04-results.Rmd-->

# Discussion

<!--chapter:end:05-discussion.Rmd-->

# Conclusions

<!--chapter:end:06-conclusions.Rmd-->


`r if (knitr::is_html_output()) '
# References {-}
'`

'r
#  {=latex} for thesis
#  {} for  elsevier
'

```{=latex}
\cleardoublepage
    \bookmarksetupnext{level=part}
    \phantomsection
    \addcontentsline{toc}{chapter}{References}
    \begin{centering}
    REFERENCES\\
    \vskip 1 \baselineskip
    \end{centering}
    
```


<div id="refs"></div>


<!--chapter:end:07-references.Rmd-->

