---
always_allow_html: yes
title: |
  | Forecasting Ride-hailing across  
  |  Multiple Model Frameworks
# Your thesis title should be inverted pyramid-shaped, with the longest
# line on top and shorter lines below. Add a new line as tab-|-space-Words
author: 'Christopher Day'
# this is the date of graduation
date: 'December 2022'
department: 'Department of Civil and Construction Engineering'
degree: Master of Science
committeechair: Gregory S. Macfarlane
committeemembers:
  - name: Grant G. Schultz
  - name: Gustavious P. Williams
keywords: 'ride-hailing, activity-based model, multi-agent simulation, ActivitySim, BEAM, tour mode, tour purpose'


# Remove the hashtag to specify which version of output you would like.
# Can only choose one at a time.
site: bookdown::bookdown_site

# Note that a tab is needed on the line after the `|`.
abstract: |
  | The advent of on-demand transport modes such as ride-hailing and microtransit has challenged forecasters to develop new methods of forecasting the use and impacts of such modes. In particular, there is some professional disagreement about the relative role of activity-based transportation behavior models — which have detailed understanding of the person making a trip and its purpose —  and multi-agent demand simulations which may have a better understanding of the availability and service characteristics of on-demand services. A particular question surrounds how the relative strengths of these two approaches might be successfully paired in practice. Using daily plans generated by the activity-based model ActivitySim as inputs to the BEAM multi-agent simulation, we construct nine different methodological combinations by allowing the choice to use a pooled ride-hail service in ActivitySim, in BEAM with different utility functions, or in both. Within each combination, we estimate ride-hailing ridership and level of service measures. The results suggest that a multi-agent simulation may overstate the demand interest relative to an activity-based model, but there may be opportunities in future research to implement feedback loops to strengthen the accuracy of ridership and level of service forecasts. 
  


acknowledgments: |
  I would first like to acknowledge my advisor and friend, Dr. Gregory Macfarlane, for teaching me everything I know. Without you, this thesis and my future career would be boring and stupid. I found a work to love and enjoy while researching under your supervision, and for that I will forever be grateful. I express gratitude as well to Dr. Schultz and Dr. Williams for being on my advisory committe and helping me finish my thesis. I would also like to acknowledge the United States Department of Transportation (USDOT) for funding my research. Thank you to the members of the T-SCORE center, especially Dr. Gregory Erhardt, Jawad Hoque, and Vedant Goyal for their friendship and help with tackling BEAM. A special shoutout to Nate Lant and Hayden Atchley for working on ActivitySim and BEAM even when we had no idea what we were doing. Together, we got this thing done. I am enormously grateful as well to Zachary Needell at Lawrence Berkeley National Laboratory for working with the T-SCORE team and me in our efforts to tame BEAM. Without you, none of this would have been possible. An additional thanks to Wasatch Front Regional Council, especially Chad Worthen, for sharing data and working with our group. Also, a standing ovation to the creators of the ggalluvial R package; this package is awesome and allowed me to make some pretty cool plots.
  
  I express sincere gratitude for my family members and their patience and support as I conducted this research. Especially, thank you to my wife Megan, because without her I would probably be dead. She convinced me to apply for this research position, held down the fort at home, let me work every Saturday for 3 years, and was patient with me everytime I went insane staring at my computer screeen. I appretiate you all. Finally, thank you to the BYU tennis courts and Kevin Lunt, because tennis is the key to happiness. 

# Specify the location of the bibliography below
bibliography: [book.bib] 

# Download your specific csl file and refer to it in the line below.
# csl styles: https://www.zotero.org/styles
csl: apa.csl

lot: true
lof: true

header-includes:
  - \usepackage{algorithm}
  - \usepackage{algpseudocode}
  - \usepackage{dsfont}
  - \usepackage{pdflscape}
  - \usepackage{rotating}
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{mathtools}
  - \usepackage{eqparbox}
  - \usepackage{makecell}
  - \usepackage{pgf}

#nocite: '@*' # include all references in .bib file

# ELSEVIER ----------------------------------------------------------------#
# change to elsevier format in _ouput.yml and references
# uncomment the following specifications (and comment THESIS section)

#layout: "3p, authoryear, review" #elsevier
#csl: elsevier-harvard-italics.csl #elsevier
#link-citations: yes

# THESIS ------------------------------------------------------------------#
# delete thesis.aux BEFORE building pdf book
# change to thesis format in _ouput.yml and references
# uncomment the following specification  (and comment ELSEVIER SECTION)
layout: 'fancy, masters'
---


<!--chapter:end:index.Rmd-->

# Introduction {#intro}

## Problem Statement
On-demand transit modes, such as microtransit and ride-hailing, can make private car-centric societies more sustainable [@tirachini20]. They have the potential to exhaust less vehicular emissions, decrease roadway congestion, increase health, increase public transit usage in some cases, and be economically viable [@marquet20; @chen21]. As urban centers attempt to shift from a private car-centric environment to a multi-modal system, forecasters are challenged with modeling accurate ridership and level of service values. Since ride-haling is already heavily involved in today's transportation system, estimating the uptake of ride-hailing usage and understanding the service capabilities of ride-hailing is critical to a sustainable future.

Unfortunately, forecasting the ridership and level of service of ride-hailing and other novel modes is a challenging feat with no clear methodological approach. Individuals using ride-hailing vehicles behave differently than when using regular car modes and so understanding their behavior and the ride-hailing service capabilities is particularly challenging [@kang21; @li20; @dong20; @dean21]. In addition, the ridership of bike share, an affordable and sustainable bike rent program, has been modeled many times each with a different methodology [@hyland18; @biehl19; @cho22; @li18; @welch20; @zhou19; @song19]. Similarly, forecasters have struggled to find the best technique for estimating the ridership of e-scooters (public electric scooters) and in what locations they would be most effective [@zuniga22; @tuli21; @zhang21; @lee21; @leeb21; @hosseinzadeh21].

Many different modeling methodologies exist with the purpose of better understanding the behavior of individuals using ride-hailing vehicles and other novel modes. For example, some forecasters use activity-based models, which construct daily activity patterns to model individual travel behavior, to better understand the travel patterns of those who use novel modes [@xu19; @muhammad19; @macfarlane21]. Other forecasters use multi-agent simulation, which focuses on modeling the interactions between different agents, to understand the level of service of transport technologies [@shimizu13; @sanchez19; @horl19b]. Some use spatial analysis joint with geography data to better understand where individuals use novel modes, like pickup and drop off locations, to travel [@hyland18; @cho22; @hosseinzadeh21]. @zhou19 have even attempted to use machine learning techniques to determine the optimal mode choice between bike-sharing and taxi services. Among these, and the other strategies that exist, some professional disagreement exists as to which approach would best serve forecasters in their efforts to model the ridership and level of service of ride-hailing to create sustainable city centers. In particular, a lack of understanding exists whether the relative strengths of an activity-based model and multi-agent simulation could be paired together successfully to model the uptake of on-demand services.

## Scope within T-SCORE
In 2020, a project from the Transit - Serving Communities Optimally, Responsively, and Efficiently (T-SCORE) Center was proposed with the goal of keeping transit sustainable and resilient into the future. As a result T-SCORE was divided up into two tracks: the community analysis track and the multi-modal optimization and simulation (MMOS) analysis track. The MMOS analysis track had the purpose of using modeling techniques to determine the effectiveness of on-demand transit modes and their efficiency at bringing users to and from transit locations. The hypothesis was that instead of having ridership of public transit compete with ride-hailing, to instead pair together ride-hailing and transit services. Modeling ride-hailing vehicles was an effective avenue toward understanding their impact on transit ridership. Figure \@ref(fig:mmos) shows the entire modeling and optimization process used in the MMOS track to analyze ride-hailing vehicles. The inputs are represented in green whereas the outputs are represented in yellow (with the exception of the mode choice model). The ideas behind the research conducted in this paper originated with an attempt to develop an optimal mode choice model structure to forecast ride-hailing service capabilities for the T-SCORE project.

```{r mmos, fig.cap='Overview of the T-SCORE MMOS tract process.', out.width='75%', fig.asp=1, fig.align='center', echo=FALSE}
knitr::include_graphics("pics/mmos_mode.png")
```

## Purpose of Research 
We develop a series of experiments to understand the relative importance of a paired activity-based model and multi-agent simulation in forecasting the use of ride-hailing services. We do this by examining the ridership and level of service of ride-hailing predicted by different activity-based model and multi-agent simulation mode choice combinations. Specifically, we use the daily activity plans generated by ActivitySim as inputs to the multi-agent simulation BEAM to establish nine different combinations of methodolgical approach. For each methodological combination, we estimate ride-hailing ridership and level of service outputs for a Salt Lake City, Utah case study region. The purpose of this research is not, however, a test of accuracy in ride-hailing ridership and level of service forecasts but instead, a in-depth comparison between different modeling approaches. With this comparison we aim to understand the relative effect different paired mode choice combinations can have in forecasting ride-hailing services. 

Section \@ref(lit) presents a brief literature review on different methodological approaches used to forecast ride-hailing services. Our specific methodological approach is then explained in Section \@ref(meth) with our results explained thereafter in Section \@ref(results). A discussion on our results along with limitations and further research ideas are presented in Section \@ref(discussion). The paper also concludes with a summary of our findings in Section \@ref(discussion).


<!--chapter:end:01-intro.Rmd-->

# Literature Review {#lit}

As discussed in the Introduction, forecasters have modeled the level of service and the individual travel behavior of ride-hailing and other novel modes in a variety of ways. To best understand a few of the methodological approaches forecasters have used, the following literature review outlines the pros and cons of using spatial analysis, activity-based models, multi-agent simulation, and paired modeling approaches to model the use and impacts of ride-hailing. Since those individuals who use novel modes in general have similar travel behavior to those who use ride-hailing, we include references to research about both ride-hailing services and other novel modes. 

## Spatial Analysis and Ride-hailing {#lit-simp}
The most prominent methodological approach to understanding ride-hailing service is through simple approaches like spatial, statistical, and empirical analyses. For example @correa17 developed heatmaps using spatio-temporal data to analyze ride-hailing pickup locations. @marquet20 processed data and used statistical measures to estimate a connection between walkability index and ride-hailing usage. @dong18 conducted an empirical analysis to understand the unique travel patterns of ride-hailing vehicles. Many other research studies have used simple approaches to estimate the ridership and service of ride-hailing and other novel modes [@li22; @hyland18; @cho22; @hosseinzadeh21; @zhou19]. 

The upside to implementing a simple spatial, statistical, or empirical analysis is its simplicity. The downside, however, is that with its simplicity comes decreased flexibility. For example, @hosseinzadeh21 determined regional attributes that affect the density of regional e-scooter trips by conducting a spatial analysis. By following a simple statistical approach they learned of the impact land use, age, and other demographics have on e-scooter use, but did not have the flexibility to understand e-scooter travel times and other level of service measures. Also, simple spatial, statistical, and empirical methods oftentimes only answer one particular geographic question. For example, @li22 estimated a correlation between the number of ride-hailing pickup and drop-offs with the location of subway services and transit routes. Although these results may provide insights on how to improve transit services, ride-hailing level of service and ridership statistics could not be estimated as well. Overall, spatial, statistical, and empirical analyses are unable to accurately forecast the ridership, level of service, and other usage measures simultaneously.

## Activity-based Models and Ride-hailing {#lit-abm}
Activity-based models are transportation behavior models that construct daily activity patterns for synthetic individuals from behavioral choice models. Activity-based models predict the set of activities to participate in before they predict how and when to get to those activities [@philip13]. By estimating activity demand before mode choice and route selection, activity-based models more accurately represent the way people travel. Activity-based models also use utility theory and logit based regression to best estimate individual decisions and travel behavior [@bowman98]. In addition to representing behavior accurately, another advantage to using activity-based models is the modal consistency between trips on the same tour [@nayak22; @hasnine21; @knapen21; @gomes21]. In other words, activity-based models ensure that individuals choose coherent modes between subsequent trips (modal consistency) when those trips occur on the same tour (a sequence of trips starting and ending at the home location). In real life, individuals travel in a similar manner among trips of the same tour. Activity-based models account for this natural tendency by chaining trips of the same individual together, or by developing a tour mode construct. A tour mode represents the primary mode any particular person selects to use on a tour. By estimating individual behavior accurately and by maintaining modal consistency among trips of the same individual, ride-hailing usage can be consistently distributed to the same trips and same individuals in activity-based models, suggesting justifiable ride-hailing selection estimates.

Many forecasters elect to use activity-based models to model ride-hailing and other modes because of the behavioral representation and modal consistency they provide. For example, @nguyen22 modeled one-way car-sharing services with an activity-based model because the modal consistency between trips allowed them to estimate vehicle usage. @xu19 modeled privately-owned autonomous vehicles with an activity-based model as a way to better understand their impact on household travel patterns. @rafiq22 used an activity-based approach to estimate the five most common tour structures of ride-hailing individuals. Activity-based models can determine the specific travel patterns of those who use ride-hailing services.

Although there are advantages to using activity-based models to model ride-hailing, forecasters must consider the various weaknesses that exist when using activity-based models. One of the biggest shortfalls with most activity-based models is that travel times are averaged along travel links [@rsg16; @mahmoudi21]. For example, although @nguyen22 used an activity-based model to model one-way car sharing, they noted that it used a regression function to estimate travel time. For this reason, @nguyen22 noted that it was more difficult to verify the service capabilities of the car-sharing modes. Many activity-based models also use pre-generated skims composed of average travel statistics to determine service related measures [@zhang18]. Skims are large matrices composed of travel time, distance, and cost that exist between every origin-destination zone combination. With a dynamic traffic assignment (DTA) model, travel statistics between every origin-destination zone are determined by spatially aggregating each zone and then by calculating average values between the centroid of each zone using a loaded network-assignment methodology. Activity-based models lack variability when modeling travel and wait times of ride-hailing and other novel vehicles because they use travel skims as a primary input. In addition, since concrete travel values are used as inputs, it can be difficult to model ride-hailing vehicle availability and passenger capacity limitations. 

## Multi-agent Simulation and Ride-hailing {#lit-mas}
An alternative to activity-based models for forecasting ride-hailing level of service is multi-agent simulation. Multi-agent simulation models interactions between individual agents by reading in a set of detailed daily activity patterns onto a transportation network [@bazghandi12; @amblard15; @siebers08]. Some multi-agent simulations also use an iterative process to maximize the individual travel utility by achieving mode, route, and overall traffic equilibrium. By forecasting travel behavior on an individual level until equilibrium is reached, varied, reasonable wait time and travel time estimations are predicted for every agent. Forecasting level of service with unique travel time statistics produces more realistic results. Along with modeling each individual closely, a multi-agent simulation keeps track of every ride-hailing vehicle as well. The complexity of the vehicular availability model along with individual travel behavior model allows multi-agent simulation to estimate exact, variable wait and travel times. For example, the model knows the exact ride-hailing vehicle availability and ride-hailing passenger capacity at every moment of the day. Therefore, capacity measures, like ride-hailing ridership and utilization, can be estimated realistically and with great precision at the individual level using multi-agent simulation. 

Various forecasters elect to use multi-agent simulation to model the level of service of ride-hailing and other novel modes because agent-to-agent and agent-to-vehicle interactions are modeled closely. For example, @kamel19 chose to use a multi-agent simulation to model shared autonomous vehicles (SAVs) because the granularity of the interaction between different agent types and SAV modes helped the researchers understand the effect user preference has on modal decisions. @horl19b also analyzed shared autonomous vehicles with a multi-agent simulation, mainly to take advantage of the detailed vehicular model. The model allowed forecasters to adjust fleet size and to optimize the way fleet vehicle drivers behaved. By utilizing the advanced vehicular model, the researchers were able to estimate the overall system performance, wait times, and cost of various autonomous vehicle fleets. Similarly, @becker20 used MATSim, an open source agent-based simulation used for large scale scenarios, to model the travel times and costs of different on-demand transit modes (ride-hailing, car-sharing, bike-sharing) [@horni16]. The primary advantage of MATSIM is that it provides a "dynamic demand response towards changes in service attributes such as travel times or costs" [@becker20]. Many forecasters continue to analyze new transportation technologies with multi-agent simulation because its inherit advantages are helpful to understanding service capabilities.

Although multi-agent simulation excels at estimating the level of service of ride-hailing vehicles at fine detail, various pitfalls do exists. For example, @ciari16 summarizes a multitude of research done to understand demand for car-sharing with the multi-agent simulation MATSim. In this research, they note that although multi-agent simulation provides an extensive level of detail, it does not necessarily equate to real world accuracy. Because MATSim uses an iterative process of maximizing individual utility until a state of overall equilibrium is reached, it remains difficult to accurately portray exact individual behavior choices [@ciari16]. The structure of the activity-based choice model allows strong individual behavioral representation, whereas the complexity of the multi-agent simulation may cause individual choices to be inaccurate and unreasonable. Similarly, where the activity-based model may excel at more realistic mode choice selections among trips of the same tour, some multi-agent simulation struggle. For example, Figure \@ref(fig:fig-mode-compare) provides a visual example of mode choice shortcoming present in some multi-agent simulations. As seen in Figure \@ref(fig:fig-mode-compare), all trips of the same tour for the activity-based model are based on the selected tour mode. This allows users to switch from one mode to another between trips, as long as they are compatible. On the other hand, the multi-agent simulation may only undergo mode choice selection on the first trip of the tour, and be trapped into using that same mode on future trips. This is not true for all multi-agent simulations, but is true for the multi-agent simulations most often used in the literature. This results in less realistic travel behavior. The last inherit weakness of multi-agent simulation is that it is computationally heavy; requiring abundant time and resources. Overall where the multi-agent simulation lacks in forecasting ride-hailing services the activity-based model excels, and vice versa, and so the combination of using both strategies could prove effective.

```{r fig-mode-compare, out.width='100%', fig.cap='Mode choice in activity-based models and multi-agent simulation.', fig.scap = "Activity-based models vs. multi-agent simulation.", out.extra = '', out.width='100%', fig.asp=1, fig.align='center', echo=FALSE}
knitr::include_graphics("pics/abm-mas-compare.png")
```

## Limited Attempts to Pair Mulitple Modeling Approaches
The varying strengths and weaknesses within both activity-based models and multi-agent simulation point to possibly using both approaches to understand ride-hailing ridership and level of service. Yet few forecasters have attempted to reconcile or pair these two disparate approaches in order to better understand the behavior of ride-hailing and other novel modes. However, one example of reconciling the traditional approaches is with the Microsimulation Transport Orchestrator (MITO) system [@moeckel20; @zwick21]. MITO's primary purpose is to overcome the limitations of the traditional trip-based model while being easier to implement than the traditional activity-based model. Like an activity-based model, MITO simulates each agent individually. MITO also includes a simplified activity schedule builder, allows forecasters to add attributes, allows agent tracing, and is not as computationally heavy as traditional multi-agent simulations [@moeckel20]. @zwick21 used MITO to estimate travel demand and MATSim to simulate that demand. By pairing together MITO and MATSim, the researchers were able to gather service criteria for pooled on-demand ride-hailing vehicles at a detailed level, while also maintaining the behavioral integrity of each agent. 

Another example of pairing together two disparate modeling approaches involves discrete choice and MATSIM. Since MATSim implements a feedback loop to determine mode choice instead of using a discrete choice model, some researches have attempted to pair together a discrete mode choice model with MATSim in attempt to shorten the number of iterations needed to be run. For example, @horl19 discovered that by using a discrete choice model within MATSim, no irrelevant mode choice decisions were made. This indeed, lead to less iterations being run while enhancing the realistic nature of the mode choice selection. However, although initial modal decisions were more accurate than the default MATSim model, the discrete choice model added a layer of complexity. The need for more accurate and useful data gave the model runners less freedom. 

## Summary

Overall, these few examples show that by pairing together multiple model frameworks the strengths of each model is maximized. To the authors knowledge, however, no previous literature exists on pairing together an activity-based model and a multi-agent simulation for the purpose of modeling ride-hailing ridership and level of service. By using an activity-based model we can take advantage of the strong individual behavior representation and realistic mode choice decisions. By using a multi-agent simulation we can take advantage of the vaste individual travel behavior detail and the advanced vehicular availability model. We therefore hypothesize that with a joint activity-based model and multi-agent simulation, we can utilize the advantages of both models to capture ride-hailing ridership and level of service measures. And so, the objective of this study is to better understand the significance of using a linked activity-based model and multi-agent simulation in forecasting the usage of ride-hailing modes. 

<!--chapter:end:02-lit-review.Rmd-->

```{r, include = FALSE}
library(targets)
library(tarchetypes)
library(tidyverse)
library(data.tree)
library(knitr)
library(kableExtra)
library(DiagrammeR)
library(ggpattern)

# Instructions and options =========
# prints missing data in tables as blank space
options(knitr.kable.NA = '') 
# tells kableExtra to not load latex table packages in the chunk output
options(kableExtra.latex.load_packages = FALSE) 

# options for latex-only output
if(knitr::is_latex_output()) {
  knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
} 
```

# Methods {#meth}
We developed a series of experiments to understand the relative importance of pairing an activity-based and multi-agent simulation in forecasting the uptake of ride-hailing. We performed these experiments using ActivitySim as the activity-based model and BEAM as the multi-agent simulation. We used the Salt Lake City, Utah region as a case study for our experiments. The following section outlines the methodology for which we were able to model ride-hailing ridership and level of service with differing activity-based model and multi-agent simulation mode choice combinations.

## Ride-hailing in ActivitySim
We chose ActivitySim as the activity-based model in this research because it is an open-source software with ride-hailing modal alternatives built into its framework [@rsg21]. Specifically, the ride-hail mode and the pooled ride-hail mode fall under one of the four nested tiers of ActivitySim's nested logit mode choice model. This means that ride-hail is a unique modal option not characterized by being an auto, non-motorized, or transit type mode. Figure \@ref(fig:fig-asim-nest) displays the four tiers of the nested logit mode choice model along with the modal alternatives of each tier [@mtc12]. These modal alternatives represent the alternatives available in both ActivitySim's tour based and trip based mode choice model. When determining the mode to use on a trip, ActivitySim first calculates the tour mode and subsequently calculates the trip mode based on the tour mode selection (See Figure \@ref(fig:fig-mode-compare)). Person attributes, path attributes, location attributes, tour purpose value (the main activity purpose of the tour), and more all play a role in calculating the mode choice decision. 

```{r fig-asim-nest, fig.cap = "Nested logit model used in ActivitySim.", fig.asp=1, fig.align='center', out.extra = 'trim = {3cm 9.5cm 4.5cm 6cm}', out.width="1.8\\linewidth", wrapfigure = list("R", .5), echo=FALSE}
choice <- Node$new("Choice")
  auto <- choice$AddChild("Auto")
    drivealone <- auto$AddChild("Drive-Alone")
    sharedride2 <- auto$AddChild("Share-Ride 2")
    sharedride3 <- auto$AddChild("Shared-Ride 3+")
  nonmotorized <- choice$AddChild("Non-Motorized")
    walk <- nonmotorized$AddChild("Walk")
    bike <- nonmotorized$AddChild("Bike")
  transit <- choice$AddChild("Transit")
    walkaccess <- transit$AddChild("Walk-Transit")
    driveaccess <- transit$AddChild("Drive-Transit")
  ridehail <- choice$AddChild("Ride-Hail")
    taxi <- ridehail$AddChild("Taxi")
    tnc_single <- ridehail$AddChild("Ride-Hail Single")
    tnc_shared <- ridehail$AddChild("Ride-Hail Shared") 
#print(choice)

SetNodeStyle(choice, style = "filled,rounded", shape = "box", fontname = "helvetica", tooltip = GetDefaultTooltip)
plot(choice)
```

In ActivitySim, the utility $V$ for person $n \in {1:N}$ choosing alternative mode $k \in K$ between origin zone $i \in I$ and destination zone $j \in J$ is:

\begin{align}
  V_{nk}^{Person} =& \ \alpha_{kn} + \beta_{kP}^1(cost_{k,ij}) + \beta_{kP}^2(age_{n}) 
   + \beta_{kP}^3(hhsize_{n}) (\#eq:person) \\
  V_{nk}^{Path} =& \ \beta_{kP}^4(dist_{k,ij}) +  \beta_{kP}^5(tv_{k,ij}) + 
       \beta_{kP}^6(te_{k}) +  \beta_{kP}^7(tw_{k}) + \nonumber \\ 
      & \ \beta_{kP}^8(prox_{k}) + \beta_{kP}^9(xfer_{k})  (\#eq:path) \\
  V_{nk}^{Location} =&  \ \beta_{kP}^{10}(ZDI_{k,i}) + \beta_{kP}^{11}(ZDI_{k,j}) + 
      \beta_{kP}^{12}(ZTI_{k,j}) + \nonumber \\ 
      & \ \beta_{kP}^{13}(CBD_{k,j}) (\#eq:location)\\
  V_{nk} =& \ V_{nk}^{Person} + V_{nk}^{Path} + V_{nk}^{Location} (\#eq:all)
\end{align}
where, $\alpha$ is the alternative specific constant that varies by auto sufficiency,  $hhsize$ is household size, $dist$ is distance, $tv$ is vehicle travel time, $te$ is egress time, $tw$ is wait time, $prox$ is proximity to transit, $xfer$ is number of transfers, $ZDI$ is zonal density index, $ZTI$ is zonal topography index, $CBD$ is central business district, and $\beta_{P}^1:\beta_{P}^{13}$ are estimated coefficients that vary by tour purpose $P$. Equation \@ref(eq:person) shows part of the ActivitySim's mode choice utility function that focuses on person variables. Equation \@ref(eq:path) shows the part of the mode choice utility function that focuses on path variables. Equation \@ref(eq:location) shows the part of the mode choice utility function that focuses on location variables. As shown in Equation \@ref(eq:all), ActivitySim uses the combination of person, path, and location variables to calculate the mode choice alternative. The combination of these different variable types determines whether or not a person selects a ride-hailing mode. In addition, since activity-based models do not use variable wait time, the average wait time is selected before the model run. 


## Configuring ActivitySim
ActivitySim requires three inputs:

  1. A synthetic population of the agents within the study area.
  2. A zonal socioeconomic data file describing the characteristics of each zone.
  3. A set of skims that describe the cost and travel times of all modes between all zones.
  
We generated the synthetic population by inputting a seed table and a set of regional targets into PopulationSim [@popsim]. We created the zonal socioeconomic file using data from Wasatch Front Regional Council (WFRC) [@wfrc], Utah Automated Geographic Reference Center [@agrc], and the synthetic population when necessary. Finally we used travel time and cost skims that were pre-generated from @wfrc. For additional details relating to how the inputs were processed and gathered please refer to the research conducted by @macfarlane21.

After generating the necessary input files, we calibrated and validated the ActivitySim model to better represent decisions made in the Salt Lake region. The process of calibrating and validating the ActivitySim model to the Salt Lake region was conducted by @macfarlane21. The purpose of the calibration and validation was to ensure that the outputs generated by ActivitySim matched target regional values. Specifically, trip productions, trip distributions, and mode choices were tested to match the given target values provided in the four-step model from @wfrc. The details behind the exact calibration and validation process are discussed by @macfarlane21, and therefore will not be described in detail within this paper. 

## Ride-hailing in BEAM  {#novel-beam}
The Behavior, Energy, Autonomy, and Mobility (BEAM) model, developed by Lawrence Berkeley National Laboratory and UC Berkeley Institute for Transportation Studies, was chosen as the multi-agent simulation in this research [@beam]. As an extension of MATSim, it simulates individual agents using both within day replanning and across-day replanning to maximize individual utility. BEAM was mainly chosen as the multi-agent simulation in this research because of its integration with ride-hail and pooled ride-hail vehicles. Along with the ride-hailing type mode options, BEAM supports other mode options such as car, walk, bike, walk-to-transit, and drive-to-transit. The default BEAM version uses a simple multinomial logit mode model to determine which mode any particular agent will use on any particular trip. The default version of BEAM calculates the utility $V$ for person $n \in {1:N}$ choosing alternative mode $k \in K$ between origin zone $i \in I$ and destination zone $j \in J$ as: 

\begin{equation}
  V_{nk} = \alpha_{k} + \beta_k^1(cost_{k,ij}) + \beta_k^2(tv_{k,ij}) + \beta_k^3(xfer_{k}) (\#eq:beam)
\end{equation}
where, $\alpha$ is the alternative specific constant that varies mode, $tv$ is vehicle travel time, $xfer$ is number of transfers and $\beta_{P}^1:\beta_{P}^{3}$ are estimated coefficients that vary mode.

However, we improved the BEAM's default mode choice model in order to better estimate the ride-hailing choices of individuals. Specifically, we changed the BEAM mode choice model to use a tour purpose attribute, the same utility equations as ActivitySim (See Equation \@ref(eq:all)), and additional modal alternatives consistent with those present in ActivitySim.  Appendix A provides a deeper explanation of these changes.

In addition to having a consistent mode choice structure with that of ActivitySim, BEAM implements ride-hailing vehicular behavior and assignment. BEAM uses a greedy asynchronous ride-hailing matching algorithm that also supports pooled trips [@beam]. The algorithm works by requiring agents to send a request for a ride-hail vehicle, and then by matching the closest vehicle available to that agent. For the algorithm to work, BEAM requires the modeler to input a ride-hail vehicle fleet. This fleet is a simple file that describes the number of ride-hail vehicles available in the region, their starting locations, their working hours, their seating capacity, and other specifications. Our fleet was generated by a student at Georgia Institute of Technology who used statistical models to predict fleet specifications. BEAM assigns fleet vehicles to the roadway network, where they "roam" the streets awaiting requests. The ride-hail algorithm permits a more realistic ride-hail modeling structure. For example, agents make a request to take a ride-hail vehicle, expect a variable wait time dependent on their geographic location, and may not even be able to take the vehicle if there is no availability. All these attributes are similar to how using ride-hailing is in real life, and represent the true advantages to modeling ride-hailing ridership and level of service with BEAM. 


## Configuring BEAM
BEAM was configured to the case study region by gathering the input data, validating the utility parameter values, and calibrating the utility alternative specific constants (ASC) to match regional totals. Most of the BEAM input files were directly generated by the calibrated ActivitySim model, with the exception of the network from @wfrc and the General Transit Feed Specification (GTFS) data from @gtfs. The utility parameter coefficients used in BEAM's mode choice model were copied directly from Metropolitan Transportation Commission's (MTC) implementation of ActivitySim [@mtc12]. MTC's implementation of ActivitySim was designed for the San Francisco, California region. Logically, travel behaviors such as travel time, travel distance, and number of transfers should affect people in different regions in similar ways. However, as a way to validate the use of ActivitySim's path utility coefficients in the Salt Lake region, we compared these values to values from the Utah Statewide model [@utahstate], the WFRC travel demand model [@wfrc], and National Cooperative Highway Research Program (NCHRP) Report 716 [@nchrp]. The Utah Statewide model provided a rough idea of the influence of path variables in Utah as a whole. The WFRC model provided a direct comparison of travel behavior for the same region of study used in this research. NCHRP Report 716 provided default parameter values from a generalized modeling point of view. Overall, comparing these three sets of path parameter values with the MTC ActivitySim parameter values used in BEAM helped ensure that the the mode choice utility parameters were valid.

Figure \@ref(fig:coef) shows the comparison of the path utility parameter values between all four models for home-based work, home-based school, and home-based other trips. To view all parameters on the same scale, each value is divided by the vehicle travel time coefficient. For the egress time, vehicle travel time, the number of transfers, transfer time, and the wait times, MTC's ActivitySim seems to use a very similar coefficient value as the other three models. The largest discrepancy exists with short and long walking distances. ActivitySim seems to use a value almost 10 fold that of the other models. This occurs because the WFRC and Utah Statewide models cap walking distance whereas ActivitySim instead gives a high penalty for long walking distances. With this clarification, it is clear to see that ActivitySim's path coefficient values do not require calibration and were left as is because the parameters fall within a close range of the other models.

```{r coef, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Mode choice path coefficients model comparison by tour purpose.", fig.scap="Path coefficients model comparison.", out.extra='', fig.align='center'}
tar_read(coef_graph)
```

Lastly, after completing the utility parameter validation we calibrated the mode choice utility function's alternative specific constants. The new ASC value $\alpha'$ was calculated as:

\begin{equation}
  \alpha_{nk}' = \alpha_{nk} + ln(\frac{T_{nk}^{ASIM}}{T_{nk}^{BEAM}}) (\#eq:eqcalib)
\end{equation} 
where $n$ is auto sufficiency, $k$ is modal alternative, $\alpha$ is the previous iteration's ASC value, $T^{ASIM}$ is ActivitySim trip shares, and $T^{BEAM}$ is BEAM trip shares. We completed the BEAM calibration through an iterative process of updating ASC values using Equation \@ref(eq:eqcalib). After completing 15 iterations of compounding Equation \@ref(eq:eqcalib) on the ASC values, the BEAM trip values were within a reasonable range to the ActivitySim target shares. Figure \@ref(fig:fig-beam-calib) shows the progress of the calibration targets with the final shares after each iteration. 

```{r fig-beam-calib, fig.dim = c(7,9), fig.cap="BEAM mode choice calibration process. Note that the y axis grouping titles are activity types where 'Discr.' represents 'Discretionary' and 'Escort' represents dropping someone off.", fig.scap="BEAM mode choice calibration process."}
#, dev='tikz'
beam_calib <- tar_read(beam_calib)
beam_calib
```


## Case Study Scenarios {#meth-scenarios}
After completing the BEAM validation and BEAM calibration for the case study region, we designed a series of different BEAM experiments. We ran each experiment for a total of 12 iterations using a 15% population size. More specifically, we conducted nine different experiments, each with a unique ActivitySim-to-BEAM mode choice combination. Table \@ref(tab:tbexperiments) provides a short name description of the nine different scenarios. 

\begin{table}
\caption[ActivitySim-to-BEAM Mode Choice Combination Names]{ActivitySim-to-BEAM Mode Choice Combination Scenario Names}
\vspace{-10mm}
\renewcommand{\arraystretch}{2}
\[
  \begin{array}{cc|ccc}
    &\multicolumn{1}{c}{} & \multicolumn{2}{c}{\text{ActivitySim}} \\
    && \text{Plans without ride-hail} & \text{Plans with RideHail}\\
    \hline
    & \text{None} & \text{} & \text{AsimRideHail} \\
    \smash{\rotatebox[origin=c]{90}{\text{BEAM}}} & \text{RideHail} & \makecell{\text{BeamRideHail:Path} \\ \text{BeamRideHail:PPL}} & \makecell{\text{AsimBeamRideHail:Path} \\ \text{AsimBeamRideHail:PPL}} \\
    & \text{All} & \makecell{\text{BeamAll:Path} \\ \text{BeamAll:PPL}} & \makecell{\text{AsimBeamAll:Path} \\ \text{AsimBeamAll:PPL}}
  \end{array}
\]
\label{tab:tbexperiments}
\vspace{-10mm}
\end{table}

To better describe the meaning of each scenario in Table \@ref(tab:tbexperiments), we explain the three mode choice descriptors that were altered in each scenario. The first descriptor refers to how ActivitySim's modes were configured, which in Table \@ref(tab:tbexperiments) is labeled under *ActivitySim* as *Plans without RideHail* and *Plans with RideHail*. In the naming convention, any name starting with *Asim* refers to any scenario where ride-hailing was included in the input plans from ActivitySim, and any name without *Asim* refers to any a scenario where ride-haling was excluded from the inputs plans from ActivitySim. In other words, the ActivitySim ride-hailing nesting option as shown in Figure \@ref(fig:fig-asim-nest) only existed in one version of ActivitySim. Since the daily activity plans generated by ActivitySim were converted to BEAM inputs, this descriptor explains the initial mode choice selections for all trips entered into BEAM. 

The second descriptor present in Table \@ref(tab:tbexperiments) is labeled under *BEAM* as *None*, *RideHail*, and *All*. These three variables explain which mode choice structure was used in BEAM. These variables also explain which modal alternatives were available for choice within BEAM. The *None* category represents a version of BEAM where all modal innovation was turned off. This means that no mode choice was available and agents did not select to choose alternate modes. The *RideHail* category represented a version of BEAM where modal innovation was partially turned off. All trips that originally took car or carpool modes had modal innovation turned off; their modes were locked. All trips that originally took walk-transit or drive-transit modes, however, were given the option to switch to a ride-haliing mode. Also, all walk modes were given the option to switch to a ride-hail vehicle. *RideHail* represents the version of BEAM where ride-hail and ride-hail transit modes were only given to none-car dependent agents. Finally, the *All* category represents a version of BEAM where modal innovation was turned on, and all modal alternatives were available for choice. This means that within-day replanning as well as across-day replanning was turned on, and agents could change their trip modes to maximize their utility. 

Finally, the third descriptor present in Table \@ref(tab:tbexperiments) is labeled as either *Path* or *PPL* and explains which utility variables were used to calculate modal utility. The *Path* option represented the version of BEAM that used Equation \@ref(eq:path), which used only path type utility parameters to calculate mode choice utility. The *PPL* option represented the version of BEAM that used Equation \@ref(eq:all), which used all path, person, and location type utility parameters to calculate mode choice utility.

## Summary

Overall, we ran nine different scenarios each with a slightly different ActivitySim-to-BEAM mode choice combination. Each scenario is built from which modes were included in the input plans, which modal alternatives were available for choice, and which utility parameter types were used to calculate the mode choice utility. By altering these three different mode choice characteristics, we hope to better understand the affect a linked activity-based model and multi-agent simulation have on ride-hailing ridership and level of service. 

<!--chapter:end:03-methods.Rmd-->

# Results {#results}
We estimated ride-hailing ridership and level of service for each of the nine previously mentioned ActivitySim-to-BEAM mode choice combinations. Specifically, we estimated ride-hailing ridership, wait time, and utilization. Alongside each other, these results shed light on the performance of estimating ride-haling ridership and level of service with an activity-based model and multi-agent simulation. We can see how differing mode choice structures affect the use and performance of ride-hailing modes.

## Ridership {#res-ridership}
Table \@ref(tab:ridership) shows the number of trips for the ride-hail, pooled ride-hail, and ride-hail transit type modes for all nine mode choice combinations. Table \@ref(tab:ridership) also includes the number of trips within the plans with ride-hail created by ActivitySim, before the mode choices were changed by BEAM.

```{r ridership, echo=FALSE}
library(kableExtra)
finalRidership <- tar_read(finalRidership)
kbl(finalRidership, caption = 'Ride-hail Ridership by Number of Total Trips by Mode Choice Combination Scenario.', caption.short = "Ride-hail Ridership by Number of Total Trips", booktabs = TRUE, linesep = c("\\addlinespace",rep("",9)), format="latex") %>%
  row_spec(1,italic = TRUE, background = "#D9D9D9") %>%
  row_spec(2, background = "#FAEBD7") %>%
  row_spec(3:6, background = "#FFB6C1") %>%
  row_spec(7:10, background = "#ADD8E6")
```

By comparing scenarios against each other, we can understand how slight differences in the mode choice model can significantly affect ridership totals. We first compare the ActivitySim scenario with the AsimRideHail scenario. The ActivitySim scenario represents the ride-hailing input plans created by ActivitySim before being inserted into BEAM and the AsimRideHail scenario represents how these ride-hailing input plans change in BEAM while undergoing no new mode choice. Comparing these two scenarios we see the estimated 4,249 ride-hailing trips of ActivitySim diminished to 300 trips within BEAM because the AsimRideHail scenario was unable to recreate the same ride-hailing paths as ActivitySim. Then, comparing the *RideHail* and *All* type scenarios with the AsimRideHail scenario and ActivitySim scenario we see that when BEAM mode choice innovation is turned on for all or part of the agents, BEAM predicts significantly higher ridership totals. As a result, we suppose that BEAM is prone to estimating higher ridership totals for ride-hailing modes than ActivitySim when modal innovation is turned on, and lower totals when turned off.

Next, we examine the effect the existence of ride-hailing in the input plans has on ridership. As shown in Table \@ref(tab:ridership), minimal differences in ridership is produced between scenarios with the *Asim* prefix vs. without. For example, between the BeamRideHail:Path and AsimBeamRideHail:Path scenarios we see that input plans without ride-hail produce 72,958 trips, whereas input plans with ride-hail produce 67,829 trips. Similarly, the gap between the ride-hailing trips of the BeamRideHail:PPL and AsimBeamRideHail:PPL scenario is relatively close, at 62,463 and 78,597 trips respectively. The output ridership trips are almost identical between the BeamAll:PPL and AsimBeamAll:PPL scenarios and close between the BeamAll:Path and AsimBeamAll:Path scenarios as well. Overall, we see similar ridership results among similar mode choice structures independent of the inclusion of ride-hailing in input plans.

We also notice that different BEAM mode choice models predict different ride-hailing ridership levels. The *None* type scenario (AsimRideHail) produces few agents choosing ride-hail. The *RideHail* type scenarios produce the largest number of ride-hail modes among BEAM mode choice structures. The *All* type scenarios produce more ride-hail modes than the *None* type, but less ride-hail modes than the *RideHail* type. In addition, the *All* type scenarios predicts similar ridership values as ActivitySim. The number of ride-hail only type trips is 2,259 more in the BeamAll:Path scenario than in the ActivitySim scenario. Overall, ridership is affected significantly by which mode choice structure is used by BEAM; this conclusion is clear. 

Finally, we analyze the effect the BEAM utility variables have on ride-hail ridership totals. Comparing the BeamRideHail:Path and BeamRideHail:PPL scenarios we see ride-hail only ridership decreases (45,001 and 18,907) when using path, person, and location variables, but increases with pooled ride-hail (25,014 and 38,935) and ride-hail transit (2,943 and 4,621). This same pattern occurs when analyzing the difference between the BeamAll:Path and BeamAll:PPL, and AsimBeamAll:Path and AsimBeamAll:PPL scenarios. For some oddity though, AsimBeamRideHail:Path and AsimBeamRideHail:PPL follow an opposite pattern. We acknowledge that not all scenarios follow the same pattern, but hypothesize that in general, using only path variables to estimate ride-hail ridership will result in less total ride-hail ridership than if using all path, person, and location type variables.


## Wait Times {#res-waits}
Figure \@ref(fig:waits) shows a detailed distribution of wait times for ride-hailing vehicles for the scenarios. As with ridership, we compare the scenarios with the *Asim* prefix against the scenarios without, and see only a slight difference in maximum wait times. Scenarios AsimBeamRideHail:PPL, AsimBeamAll:Path, and AsimBeamAll:PPL have almost identical mean wait times when compared to their counterparts in BeamRideHail:PPL, BeamAll:Path, BeamAll:PPL. We suppose that the existence of ride-hail in the initial plans will not affect *most* ride-hail wait times. 

```{r waits, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Distribution of ride-hail wait times by mode choice combination scenario.", fig.scap = "Distribution of ride-hail wait times.", out.extra='', fig.align='center'}
tar_read(waits)
```

Alternately, comparing different BEAM mode options does significantly affect ride-hail wait times. The *None* type scenario (AsimRideHail) has the largest spread of wait times, the lowest mean wait time, and is "bottom heavy" -- referring to the fact that a major cluster of users wait less than 7.5 minutes. The *All* type scenarios have higher mean wait times (~9.3 minutes) than the *None* type and lower mean wait times than the *RideHail* type. Neither top nor bottom heavy, the *All* type scenarios seem to have a more even spread in wait times, ranging from 0.4 to 21 minutes. BEAM seems to paint ride-hail alternatives as more desirable than ActivitySim, as more users are willing to wait longer (12 to 18 minutes in the *All* scenarios). This is especially true with the *RideHail* type scenarios, as a large cluster of users are willing to wait 7.5 to 20 minutes. The *RideHail* type scenarios have the largest mean wait times (~10.65 minutes). Overall, wait time is significantly affected by which mode choice structure is used by BEAM, just like as was concluded with ridership.

The last group to compare collectively is between the Path and PPL models. By comparing BeamRideHail:Path and BeamRideHail:PPL, BeamAll:Path and BeamAll:PPL, and AsimBeamAll:Path and AsimBeamAll:PPL, we see that the Path models estimate a slightly higher maximum wait time. In addition, BeamRideHail:Path and AsimBeamRideHail:Path seem to have a larger cluster above a 10 minute wait time than BeamRideHail:PPL and AsimBeamRideHail:PPL. Besides these two observations though, the differences between utility parameters is minimal. Although ridership was affected by which utility parameters were used, wait time is only slightly affected.

Overall, by analyzing the ridership and wait times among different mode choice structures we learn that ride-hailing ridership and level of service is significantly affected by which mode choice structure is used in BEAM. We also propose that initial plans, and whether or not they include ride-hail, do not significantly affect the level at which BEAM estimates ridership or wait times. Lastly, we hypothesize that using all path, person, and location type variables will increase total ridership. We also suggest that the lack of person attributes in the utility equation may cause pooled and transit ride-hail options to look less appealing. Section \@ref(deep-look) takes a deeper look at why some of these patterns in the ridership and wait times results exist.

## Mode Choice Structures {#deep-look}
The results from Table \@ref(tab:tbexperiments) and the results from Figure \@ref(fig:waits) can be explained further by understanding the original setup of the experiments. The clearest distinction in ridership and wait times exist between BEAM mode choice structures. The *None*, *RideHail*, and *All* structure types each produce results at different magnitudes. These vastly different results are directly related to how each model structure is constructed.  

### None Mode Choice Model {#type1}
The *None* mode choice model produces the lowest ridership and shortest wait time values. With modal innovation turned off, agents were unable to choose new modes, and averted to walk modes if the current trip mode was deemed "impossible". This is verified by looking at Table \@ref(tab:noneloss). Iteration 0 (start) shows the number of ride-hailing modes input to BEAM. By the end of iteration 0, however, more than half the initial ride-hailing selections estimated by ActivitySim were lost. Then, by the end of the final iteration, only 300 ride-hailing trips remained. At the same time, total walk modes increased across each iteration. BEAM was unable to match agents with most of ActivitySim's ride-hailing predictions.

```{r, noneloss}
none <- matrix(c("0 (start)", 2412, 1837, 0, 4249,"0 (end)", 978, 615, 0, 1593, "12 (end)", 269, 21, 0, 300), ncol=5, byrow=TRUE)
colnames(none) <- c("Iteration", "Ride-hail", "Pooled Ride-hail", "Ride-hail Transit", "Total")
nonetab <- as.tibble(none)
kable(nonetab, caption = 'Loss of Ride-hailing Trips in the None Mode Choice Model.', booktabs = TRUE)  %>%
  kable_styling(latex_options="scale_down")
```

### All Mode Choice Model {#type3}
The *All* BEAM mode choice model uses the same mode choice utility function as ActivitySim and has all modal alternatives available. This adjusted model structure helps us understand why we obtained much higher ridership than with the *None* Model. Figure \@ref(fig:piechart) shows from which modes agents who switched to ride-hailing came from; in other words, its a comparison of the the trips with ride-hailing after the final iteration and their original modes in the input plans. Interestingly enough, the majority of agents who select ride-hail switched from car type modes. We define car type modes as either a car, a high occupancy vehicle with two passengers (HOV2), or a high occupancy vehicle with three or more passengers (HOV3)

```{r piechart, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Original mode choices of agents who switch to a ride-hail type mode.", fig.scap="Original mode choices of agents who switch to ride-hail.", out.extra='', fig.align='center'}
tar_read(piechart)
#planshifts <- tar_read(planshifts)
#planshifts
#ggsave("planshifts.png", width = 12, height = 6)
#planshifts_facet <- tar_read(planshifts_facet)
#planshifts_facet
#ggsave("planshifts_facet.png", width = 12, height = 6)
# below is for wRH-All-All scenario
```

We offer some factors as to why so many car users switch to ride-hailing modes. The first is the array of utility parameters boosted the ride-hailing utility, making ride-hailing options attractive alternatives. Figure \@ref(fig:sankey) provides sufficient evidence for this claim. Figure \@ref(fig:sankey) shows a Sankey diagram of all modal decisions at the start of each iteration for those agents in the AsimBeamAll:PPL scenario who select the ride-hail mode by the end of the final iteration. The mode "Cleared Mode" describes those modes that were cleared and reset at the beginning of each iteration. Notice how many of the Car, HOV2, HOV2 Passenger, HOV3, and HOV3 Passenger modes shift into the "Cleared Mode" category each iteration. Also notice in the subsequent iteration how many of those "Cleared Mode" choices shift to ride-hailing modes. A shift from the "Cleared Mode" choice to ride-hail represents those agents choosing their mode based on the utility value. 

\begin{sidewaysfigure}

\centering
\includegraphics[width = 1.05\paperwidth]{planshifts.png}
\caption[Selection process of agents who switch to ride-hail.]{The modal selections at each iteration start of those agents who selected a ride-hailing mode at the end of iteration 12 (AsimBeamAll:PPL Scenario).}
\label{fig:sankey}

\end{sidewaysfigure}

Figure \@ref(fig:sankey2) further proves that many agents elect to use ride-hailing modes because the utility parameters represent them as attractive alternatives. Figure \@ref(fig:sankey2) displays the total number of ride-hailing trips at the end of each iteration as well as which modes were used on those same trips at the beginning of the iteration for the AsimBeamAll:PPL scenario. Notice how for the majority of iterations, a substantial share of agents move from the "Cleared Mode" category to a ride-hailing choice instead. Interestingly though, before the beginning of the next iteration, most of those ride-hailing modes are lost, and new agents convert to a ride-hailing mode. This process continues, and explains why a substantial jump in ride-hailing trips occur between iteration 11 and iteration 12 in Figure \@ref(fig:sankey). In other words, only a small share of ride-hailing trips are retained across each iteration, and instead the majority of ride-hailing trips are produced from individuals with their modes cleared or from the car and walk modes. 

\begin{sidewaysfigure}

\centering
\includegraphics[width = 1.05\paperwidth]{planshifts_facet.png}
\caption[Trips that switch to ride-hail by iteration.]{The modal selections at each iteration start of the agents who selected a ride-hailing mode at each corresponding iteration end (AsimBeamAll:PPL Scenario).}
\label{fig:sankey2}

\end{sidewaysfigure}


Another factor for why agents switch from car to ride-hailing is BEAM's complex car tracking algorithm, which keeps track of household and agent level vehicle allocation. For example, if a household owns one vehicle, then the vehicle is *assigned* to the first agent to use it in their daily plan. This leaves the other household members to choose an alternate mode. BEAM's implementation of vehicular assignment prevents many agents from selecting a car mode, whereas ActivitySim may not prevent those same individuals from car usage.

In addition to BEAM's vehicle assignment algorithm, BEAM's trip based mode choice structure forces some car users to switch modes. Sometimes, agents will *lose* their vehicle within the day when a pathway cannot be built. If an agent *loses* their car, car is no longer a valid modal alternative for future trips. Figure \@ref(fig:walkers) provides evidence for this statement. Figure \@ref(fig:walkers) displays a graph of those agents who start their day using a mode other than walk, but end up switching to the walk mode by the end of the day. Notice how in each hour, walk increases as car decreases or remains constant. Hundreds of car type mode users are switching to walk modes instead of remaining with their vehicle. Figure \@ref(fig:sankey) shows that many walk users shift to ride-hailing each iteration. Therefore, car users who shift to walk on one trip, may shift to ride-hailing on the next trip. This is true between corresponding iterations as well. Overall, the increase in ridership in the *All* model can be partially explained for these three reasons.

```{r walkers, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Agents who switch to walk by time of day (AsimBeamAll:PPL Scenario).", fig.scap = "Agents who switch to walk by time of day.", out.extra='', fig.align='center'}
#graph of those agents who start their day not walking, and switch to walking before the end of the day
#for wRH-All-All Scenario
tar_read(walk_switchers)
```

### Ridehail Mode Choice Model {#type2}
Finally, the way the *RideHail* BEAM mode choice model was constructed explains why their ridership and wait times were high. The *RideHail* model only permitted walk and transit users the option to switch to ride-hailing modes; car-type modes remained locked across each iteration. Whenever a ride-hailing path could be built, all walk modes were automatically given the option to choose ride-hail or ride-hail pooled and all transit modes were automatically given the option to choose ride-hail transit. Although it made logical sense to lock all car-type modes (for reasons described in Section \@ref(type3)), by giving ride-hail options only to walk and transit users, ridership increased even more than in the *All* scenario. The increase in ridership occurred because 1) BEAM's adjusted code forced ride-hail to be an option in almost all cases, and 2) in most cases ride-hail was calculated to be more attractive than walk or transit modes.

Table \@ref(tab:timeutil) provides evidence in ride-hail being an attractive mode choice alternative. Table \@ref(tab:timeutil) displays the ride-hail time utilization for each of the scenarios performed. The same ride-hail fleet was used in each of the nine scenario, composed of 952 ride-hailing driver shifts. Ride-hail time utilization was calculated as the sum of all the driver shift times divided by the sum of all passenger occupied ride-hailing travel time. The AsimRideHail scenario had the lowest ride-hail time utilization, at only 4.0%. Interestingly, the *All* type scenarios ranged from 53.1% to 62.5% ride-hail time utilization. This explains the higher wait times shown in Figure \@ref(fig:waits). Finally, by analyzing the ride-hail time utilization for the *RideHail* scenarios, we fully understand how attractive ride-hail was. With 70.3% to 73.8% of ride-hail time utilization present for the *RideHail* scenarios, we see three fourths of each driver's shift was used to transport passengers. This explains the attractiveness of the choice, the extreme increase in ridership, and  also the increased wait time for the *RideHail* type scenarios.  

```{r timeutil, echo=FALSE}
time_utilization <- tar_read(ridehail_utilization) %>% select(2,6) %>% rename("Ride-hail Time Utilization" = RideHailTimeUtilization, "Scenario Name" = ScenarioName)
kable(time_utilization, caption = 'Percent Ride-hail Time Utilization by Mode Choice Combination Scenario', caption.short = "Percent Ride-hail Time Utilization", booktabs = TRUE)
  #kable_styling(latex_options="scale_down")
```

```{r personutil, echo=FALSE}
#person_utilization <- tar_read(rh_utilization) %>% select(1,6)
#kable(person_utilization, caption = 'Ride-hail (person / hour) utilization by mode choice combination scenario.', booktabs = TRUE)  %>%
#  kable_styling(latex_options="scale_down")
```

## Summary
As seen by the explanation of the structure of the *None*, *All*, and *RideHail* type scenarios, how BEAM's different mode choice structures were programmed affected ride-hailing ridership and wait time. Fortunately, Section \@ref(discussion) further describes the deeper meaning behind the ride-hail, wait time, and mode choice structure results discovered in this section.

<!--chapter:end:04-results.Rmd-->

# Discussion and Conclusion {#discussion}

The results presented in Section \@ref(results) show that mode choice structure significantly affects forecasts of ride-hailing ridership and service capabilities. Slight changes to which mode choice alternatives are available in the multi-agent simulation as well as which mode choice utility function is used impacts ridership and level of service greatly. In addition, the programming of the internal multi-agent simulation choice structure has a huge effect on results. The more advanced vehicular assignment model of a multi-agent simulation may be needed for more realistic modeled service behavior, but its increased complexity may cause irrational results. In our research the multi-agent simulation had a tendency to overstate the demand interest of ride-hailing vehicles, whereas the activity-based model did not. This was especially true when mode choice innovation was turned on and available to all walk and transit users. However, the *All* model, described in Section \@ref(meth-scenarios), produced results closest to those predicted by the activity-based model (although still slightly overstated). This suggests that when the model structures of an activity-based model and a multi-agent simulation are aligned with similar utility equations and modal alternatives, optimal ride-hailing ridership and service capabilities can be produced.

The results also suggest that whether or not ride-hailing exists in the multi-agent simulation's input plans does not make a significant difference to forecasted ride-hailing ridership or wait times. However, the purpose of using an activity-based model was to assign initial ride-hailing choices to the correct agents at the correct moments of their day. Therefore, although the estimation of service capabilities remained constant within the multi-agent simulation, the activity-based model had a background affect on making ride-hailing choices more realistic. We suggest that when the multi-agent simulation takes full control of estimating ride-hailing service capabilities, while the activity-based model determines who and when uses ride-hailing vehicles, optimal forecasts for ridership and level of service can be obtained. Unfortunately however, the estimations made by the multi-agent simulation in our research overpowered the estimations made by the activity-based model in most cases. Therefore, we believe a feedback loop between the activity-based model and the multi-agent simulation is needed to strengthen the forecasting power of rideihailing statistics.

## Further Research
The results suggest the need for a feedback loop between an activity-based model and multi-agent simulation. We suggest an iterative process  where the ride-hailing travel and wait times of the multi-agent simulation are inputted back into the activity-based model and the recalculated activity-based model ridership and usage values are inputted back into the multi-agent simulation. This process would continue, working off of each other, until the desired equilibrium and optimization of the ride-hailing system is achieved. Building upon the consistent mode choice model system designed in this research, this iterative process could establish more realistic and reliable ride-hailing ridership and level of service forecasts.

## Limitations
Various components of the multi-agent simulation, BEAM, were not perfected. First, the mode choice coefficients in BEAM were not calibrated to exact regional values, and did not represent a completely accurate total modal distribution. In addition, some limitations existed within the BEAM software because BEAM was in development throughout the life of this project. One example is that activity plans remained constant across each iteration. Similarly, BEAM is not a tour based model whereas ActivitySim is. The mode choice models we developed within BEAM also included a few limitations. The *All* structure had various car-matching difficulties as well as path-building difficulties. The *RideHail* structure gave the ride-hail alternative to all individuals instead of only those who had undergone across day replanning.

The two biggest limitations with the input files related to the driver fleet and the network file. The driver fleet did not factor in university and school location when statistically modeling the start location of each ride-hail vehicle. Second, the network file we used only included main roadways, because it was too difficult to develop a reliable all streets network from the resources available. The last significant limitation of the research was that the results were from the 12th iteration of a 15% scenario size. Due to our limited resources with computing power, larger scenarios with more iterations was too computationally heavy for our computers. 

## Conclusion {#conclusion}
The increasing usage of on-demand transport modes such as ride-hailing and microtransit has challenged forecasters with finding the best methodology to capturing behavior related to these new modes. Spatial analysis, activity-based models, and multi-agent simulation are common methodological approaches, but some professional disagreement exists as to which approach is best for forecasting the availability and service capabilities of on-demand services. Additional question surrounds how successful a paired activity-based model and multi-agent simulation would fare in practice. By using the daily activity plans generated by ActivitySim, an activity-based model, as inputs to BEAM, a multi-agent simulation tool, we constructed nine different model combinations where the choice of ride-hailing varied between ActivitySim and BEAM. We also adjusted the mode choice utility equation between each model combination. By analyzing the ride-hailing ridership and level of service between each methodological combination, we found that pairing an activity-based model and multi-agent simulation is a promising approach to forecasting the performance of ride-hailing services. However, in our research the multi-agent simulation had a tendency to overestimate ride-hailing ridership, while estimating realistic level of service forecasts. As a result, we believe there is an opportunity in future research to implement a feedback loop between an activity-based model and multi-agent simulation to create realistic and useful ride-hailing level of service and usage estimates.

Overall, accurately predicting the behavior and service capabilities of on-demand services is the key to a sustainable future. Ride-hailing and other novel modes are central to clean air, organized cities, and the effective movement of people. By accurately predicting the usage of ride-hailing and microtransit vehicles, we can help improve our cities and our lives. Overall, we can directly change the course of our future by how we estimate ride-hailing and other travel behavior, and so, should we not estimate it with the best approaches available? This research along with future research will help in these efforts to accurately predict the ever changing behavior and capabilities of transportation itself.  


<!--chapter:end:05-discussion.Rmd-->


# References {-}
<div id="refs"></div>

<!--chapter:end:19-references.Rmd-->

# (APPENDIX) Appendix {-}

# Additions to the BEAM Mode Choice Model {#apexA}

In order to use BEAM in conjunction with ActivitySim its mode choice model was updated to be more consistent with ActivitySim’s mode choice model. More specifically, three changes were made to the choice structure:

  1. Adding a Tour Purpose Attribute
  2. Adding Person, Path, and Location Attributes to the Utility Equation
  3. Adding New Modal Alternatives
  
First, we added a tour purpose attribute at the trip level, to be used when making trip-based modal decisions. ActivitySim's default utility parameters are segmented by tour purpose, auto ownership, and mode; therefore, it was essential to add a tour purpose level attribute to calculate the mode choice utility similar to ActivitySim. 

Second, we added multiple person, path, and location related attributes to use in the mode choice utility equations. More specifically, we changed the BEAM utility equation to use Equation \@ref(eq:all) to calculate modal utility instead of Equation \@ref(eq:beam). This was done by gathering path and location variables from the BEAM router and person level variables from the input files. The alternative specific constants were copied directly from the MTC ActivitySim example, and then calibrated later on. Overall, we created one input file which housed all path, person, and location type parameters on a tour purpose, auto ownership, and modal level. 

Adding new modal alternatives was the last major adjustment we made to the BEAM software. The most important difference between the ActivitySim modal options and the BEAM modal options is the inclusion of carpooling vehicles (HOV2 and HOV3). HOV2 means High Occupancy Vehicle with 1 passenger (2 people in the vehicle) and HOV3 means High Occupancy Vehicle with 2 or more passengers (at least 3 people in the vehicle). We adjusted the BEAM software to include HOV2 and HOV3 type modes, including a distinction between drivers and passengers of those vehicles. Within the code, HOV2 and HOV3 modes were provided as modal options by transforming an existing car option into an HOV option. This allowed car travel statistics to be transferred over to the carpooling modes, which were essential to calculating the utility.

To understand the complexity of the new mode choice model in BEAM, two pseudocode algorithms are provided. Algorithm 1 describes the process behind determining the mode choice alternatives for each agent. This process occurs for every agent for every trip. Two procedures are presented within the first algorithm. The first procedure is called DetermineHOVAlternatives. In this procedure the HOV alternatives are created from already existing options created by the R5 router [@r5]. (The R5 routing engine helps BEAM accomplish multi-modal routing). Basically if the R5 routing engine finds an existing car path, then both HOV2 and HOV3 options are provided for choice options as well. However, if the router doesn't generate any car paths, then only passenger HOV options are provided. Passenger HOV modes, called HOV_TELEPORT, are completed by teleporting agents from origin to destination. The second procedure within Algorithm 1 describes the process behind determining the final modal alternatives. It states that if the current mode is already chosen, then no additional mode choice selection is needed. However, if no mode is currently chosen for the trip, the router, ride-hailing, and HOV alternatives are combined and presented as the final alternatives to choose from. 

\begin{algorithm} [tph]
\caption{Algorithm for Determining Mode Choice Alternatives in BEAM}
\begin{algorithmic}[1]
\Require
\State $i : origin$
\State $j : destination$
\State $n: agent$
\State $N: population$
\State $t : trip $
\State $P : plan$
\State $\vec{R}(i,j) : Router\: alternatives$
\State $\vec{RH}(i,j) : Ridehail\:alternatives$
\State $\vec{H}(i,j) : HOV\:alternatives$
\State $\vec{M}(i,j) : Final\:modal\:alternatives$
\State $C : Current\:Mode$
\State $I : Trip\:Index$
\vspace{4pt}\hrule\vspace{5pt}

\State $\vec{R} \equiv \vec{R}(i,j)$
\State $\vec{RH} \equiv \vec{RH}(i,j)$
\State $\vec{H} \equiv \vec{H}(i,j)$
\State $\vec{M} \equiv \vec{M}(i,j)$
\For {$n \in N$}
\For {$t \in P$}

\Procedure {DetermineHOVAlternatives}{$\vec{R}$, $C$}
\If {$C=None$}
  \If {$\vec{R} \ni CAR$}
    \State $\vec{H} \gets (HOV2,HOV3)$
  \ElsIf {$\vec{R} \ni HOV2$}
    \State $\vec{H} \gets (HOV3)$
  \ElsIf {$\vec{R} \ni HOV3$}
    \State $\vec{H} \gets (HOV2)$
  \ElsIf {$\vec{R} \ni WALK$}
    \State $\vec{H} \gets (HOV2\_TELEPORT, HOV3\_TELEPORT)$
  \EndIf
\Else
  \State $\vec{H} \gets None$
\EndIf
\EndProcedure
\Statex
\algstore{myalg}
\end{algorithmic}
\end{algorithm}

\addtocounter{algorithm}{-1}
\begin{algorithm}
\caption{continued}
\begin{algorithmic} [1]
\algrestore{myalg}
\Procedure {DetermineModalAlternatives}{$\vec{R}$, $\vec{RH}$, $\vec{H}$, $C$, $I$}
\If {$C = DRIVE\_TRANSIT \lor BIKE\_TRANSIT$}
  \If {$I = 0$}
    \If {$C = DRIVE\_TRANSIT$}
      \State $\vec{M} \gets (DRIVE\_TRANSIT)$
    \Else
      \State $\vec{M} \gets (BIKE\_TRANSIT)$
    \EndIf  
  \Else
    \State $\vec{M} \gets (WALK\_TRANSIT, RIDEHAIL\_TRANSIT)$
  \EndIf
\ElsIf {$C = WALK\_TRANSIT \lor RIDEHAIL\_TRANSIT$}  
  \If {$C = WALK\_TRANSIT$}
    \State $\vec{M} \gets (WALK\_TRANSIT)$
  \Else
    \State $\vec{M} \gets (RIDEHAIL\_TRANSIT)$
  \EndIf
\ElsIf {$C = HOV2\_TELEPORT \lor HOV3\_TELEPORT$}  
  \If {$C = HOV2\_TELEPORT$}
    \State $\vec{M} \gets (HOV2\_TELEPORT)$
  \Else
    \State $\vec{M} \gets (HOV3\_TELEPORT)$
  \EndIf
\ElsIf {$C = CAR$}
  \State $\vec{M} \gets (CAR)$
\Else
  \State $\vec{M} \gets \vec{R} + \vec{RH} + \vec{H}$  
\EndIf  
\EndProcedure
\EndFor
\EndFor
\Statex
\end{algorithmic}
\end{algorithm}

Algorithm 2 describes the mathematical process within BEAM for how one modal alternative is selected among all the mode choice options. By calculating the probability of choosing each modal alternative, and sampling those probabilities, a final mode choice is selected and used.

\begin{algorithm}
\caption{Algorithm for Selecting Modal Alternative in BEAM}
\begin{algorithmic}[1]
\Require
\State $i : origin$
\State $j : destination$
\State $n: agent$
\State $N: population$
\State $t : trip $
\State $P : plan$
\State $\vec{A}: attributes\:of\:agent$
\State $a: attribute\:value$
\State $\vec{M}(i,j) : Modal\:alternatives$
\State $m : alternative \in M(i,j)$
\State $\vec{U}(\vec{M}(i,j),\vec{A}):Utilities\:for\:alternatives$
\State $u: utility \in \vec{U}(\vec{M}(i,j),\vec{A})$
\State $\vec{c}: attribute\:coefficients$
\State $\mathds{P}: probability$
\State $Mode: chosen\:mode\:for\:agent\:(n)\:on\:trip\:(t)$
\State $f(\vec{X}):$
This function takes a vector of modes and  their probabilities of being chosen. With those probabilities it builds them into a cumulative distribution function, generates a random number and then drops the mode with the closest probability. This process continues until only one mode is left.
\vspace{4pt}\hrule\vspace{5pt}

\State $\vec{M} \equiv \vec{M}(i,j)$
\State $\vec{U} \equiv \vec{U}(\vec{M},\vec{A})$
\For {$n \in N$}
\For {$t \in P$}\Procedure {DetermineModalAlternative}{$\vec{M}$, $\vec{A}$, $\vec{c}$}
\For {$m \in \vec{M}$}
  \State $u \gets \sum_{a\in \vec{A}} a \times c_a$
  \State $\vec{U} += [m,u]$
\EndFor
\State $S \gets \sum_{u\in \vec{U}}e^u$
\For {$u \in \vec{U}$}
    \State $\mathds{P}(u)\gets e^u / S$
    \State $\vec{B} +=[m, \mathds{P}(u)]$
\EndFor 

\State $Mode \gets f(\vec{B})$

\EndProcedure

\EndFor
\EndFor
\Statex
\end{algorithmic}
\end{algorithm}

<!--chapter:end:21-appendix-BEAM.Rmd-->

